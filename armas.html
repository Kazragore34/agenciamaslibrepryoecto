<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armas - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-fichaje.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="stats-container" style="padding-top: 6rem;">
        <div class="fichaje-header">
            <h1>Mis Armas</h1>
            <div>
                <a href="menu.html" class="btn-primary">Menú</a>
                <a href="tickets_dinero.html" class="btn-primary">Tickets</a>
                <a href="armas.html" class="btn-primary">Armas</a>
                <a href="estadisticas.html" class="btn-primary">Estadísticas</a>
                <a id="btnPanelAdmin" href="admin.html" class="btn-primary" style="display: none;">Admin</a>
                <a id="btnEntregas" href="entregas.html" class="btn-primary" style="display: none;">Entregas</a>
                <a id="btnPerdidas" href="perdidas.html" class="btn-primary" style="display: none; background: #ef4444;">Pérdidas</a>
                <a href="perfil.html" class="btn-primary" style="background: #6b7280;">Mi Perfil</a>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Formulario de creación de entrega de arma (solo para sargentos) -->
        <div id="formularioCrearArma" class="seccion-sargento" style="margin-top: 2rem; display: none;">
            <div class="stats-card">
                <h2>Crear Nueva Entrega de Arma</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Crea una entrega de arma para un prospect.</p>
                <div id="mensajeArma" class="auth-message" style="display: none;"></div>
                <form id="formCrearArma">
                    <div class="form-group">
                        <label for="prospectSelectArma">Prospect</label>
                        <select id="prospectSelectArma" required>
                            <option value="">Seleccionar prospect...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipoArma">Tipo de Arma</label>
                        <select id="tipoArma" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="SNS">SNS</option>
                            <option value="MK2">MK2</option>
                            <option value="VINTAGE">VINTAGE</option>
                            <option value=".50">.50</option>
                            <option value="AP_PISTOL">AP PISTOL</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="cantidadBalas">Cantidad de Balas Iniciales</label>
                        <input type="number" id="cantidadBalas" min="0" value="0" required>
                    </div>

                    <div class="form-group" style="padding: 1rem; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 0.5rem;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-weight: 500; font-size: 1rem;">
                            <input type="checkbox" id="chaleco" style="width: 20px; height: 20px; margin-right: 0.75rem; cursor: pointer; accent-color: #2563eb;">
                            <span style="color: #1f2937;">Incluir Chaleco</span>
                        </label>
                        <p style="color: #6b7280; font-size: 0.875rem; margin: 0.5rem 0 0 2.75rem;">Marca esta casilla si el prospect debe recibir un chaleco junto con el arma.</p>
                    </div>

                    <button type="submit" class="btn-primary">Crear Entrega de Arma</button>
                </form>
            </div>
        </div>

        <!-- Lista de armas (activas y perdidas) -->
        <div style="margin-top: 2rem;">
            <div class="stats-card">
                <h3 id="tituloArmas">Historial de Armas</h3>
                <p style="color: #6b7280; margin-bottom: 1rem;" id="descripcionArmas">Todas las armas que has recibido (activas y perdidas). Haz click en "Solicitar Balas" para solicitar más balas en armas activas.</p>
                
                <!-- Botón para solicitar chaleco (independiente del arma) -->
                <div id="seccionSolicitarChaleco" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #dbeafe; border-radius: 0.5rem; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: 500;">¿Necesitas un chaleco?</p>
                    <button class="btn-primary" onclick="solicitarChalecoGlobal()" style="background: #3b82f6;">
                        Solicitar Chaleco
                    </button>
                </div>
                
                <div id="listaArmas">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="crypto-utils.js"></script>
    <script src="auth.js"></script>
    <script src="admin.js"></script>
    <script src="productos.js"></script>
    <script src="metas.js"></script>
    <script src="armas.js"></script>
    <script>
        requireAuth();
        
        const currentUser = getCurrentUser();
        
        // Actualizar navegación según rol
        function actualizarNavegacion() {
            const btnPanelAdmin = document.getElementById('btnPanelAdmin');
            const btnEntregas = document.getElementById('btnEntregas');
            const btnPerdidas = document.getElementById('btnPerdidas');
            
            if (esAdmin()) {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'inline-block';
            } else {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'none';
            }
            
            if (esSargentoOAdmin()) {
                if (btnEntregas) btnEntregas.style.display = 'inline-block';
                if (btnPerdidas) btnPerdidas.style.display = 'inline-block';
            } else {
                if (btnEntregas) btnEntregas.style.display = 'none';
                if (btnPerdidas) btnPerdidas.style.display = 'none';
            }
        }
        
        actualizarNavegacion();

        // Cargar prospects para el formulario de armas (solo sargentos)
        async function cargarProspectsArmas() {
            if (!esSargentoOAdmin()) return;
            
            try {
                await ensureDb();
                const snapshot = await db.collection('users')
                    .orderBy('nombre')
                    .get();
                
                const currentUser = getCurrentUser();
                // Filtrar solo prospects (excluir sargentos, admins y el usuario actual)
                const prospects = snapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .filter(user => 
                        user.id !== currentUser.id && 
                        user.rol === 'prospect' // Solo mostrar prospects
                    );
                
                const select = document.getElementById('prospectSelectArma');
                if (!select) return;
                
                select.innerHTML = '<option value="">Seleccionar prospect...</option>';
                
                if (prospects.length === 0) {
                    select.innerHTML = '<option value="">No hay prospects disponibles</option>';
                    return;
                }
                
                prospects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.nombre} ${p.apellido} (${p.username})`;
                    select.appendChild(option);
                });
                
                console.log('Prospects cargados para armas:', prospects.length);
            } catch (error) {
                console.error('Error cargando prospects:', error);
                const select = document.getElementById('prospectSelectArma');
                if (select) {
                    select.innerHTML = '<option value="">Error cargando prospects</option>';
                }
            }
        }

        // Manejar formulario de creación de arma
        const formCrearArma = document.getElementById('formCrearArma');
        if (formCrearArma) {
            formCrearArma.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!esSargentoOAdmin()) {
                    mostrarMensaje('Solo los sargentos y administradores pueden crear entregas de armas', 'error');
                    return;
                }
                
                const prospectId = document.getElementById('prospectSelectArma').value;
                if (!prospectId) {
                    mostrarMensaje('Selecciona un prospect', 'error');
                    return;
                }
                
                const tipoArma = document.getElementById('tipoArma').value;
                if (!tipoArma) {
                    mostrarMensaje('Selecciona un tipo de arma', 'error');
                    return;
                }
                
                const cantidadBalas = parseInt(document.getElementById('cantidadBalas').value) || 0;
                const chaleco = document.getElementById('chaleco').checked;
                
                try {
                    mostrarMensaje('Creando entrega de arma...', 'info');
                    await crearEntregaArma(currentUser.id, prospectId, tipoArma, chaleco, cantidadBalas);
                    mostrarMensaje('Entrega de arma creada correctamente', 'success');
                    formCrearArma.reset();
                    cargarArmas();
                } catch (error) {
                    mostrarMensaje(error.message, 'error');
                }
            });
        }

        // Cargar todas las armas (activas y perdidas)
        async function cargarArmas() {
            try {
                let armas = [];
                if (esSargento()) {
                    // Sargentos ven las armas que entregaron
                    armas = await obtenerArmasPorDealer(currentUser.id);
                } else {
                    // Prospects ven las armas que recibieron
                    armas = await obtenerArmasPorVendedor(currentUser.id);
                }
                
                // Ordenar: primero activas, luego perdidas
                const armasActivas = armas.filter(a => a.estado === 'activa');
                const armasPerdidas = armas.filter(a => a.estado === 'perdida');
                
                // Ordenar por fecha (más recientes primero)
                const ordenarPorFecha = (a, b) => {
                    const fechaA = a.fechaCreacion?.toDate() || new Date(0);
                    const fechaB = b.fechaCreacion?.toDate() || new Date(0);
                    return fechaB - fechaA;
                };
                
                armasActivas.sort(ordenarPorFecha);
                armasPerdidas.sort(ordenarPorFecha);
                
                const armasOrdenadas = [...armasActivas, ...armasPerdidas];
                
                // Mostrar/ocultar botón de solicitar chaleco
                const seccionChaleco = document.getElementById('seccionSolicitarChaleco');
                if (seccionChaleco && !esSarg) {
                    // Verificar si hay alguna arma activa sin chaleco
                    const tieneArmaSinChaleco = armasActivas.some(a => !a.chaleco);
                    // Verificar si ya hay una solicitud pendiente de chaleco
                    const tieneSolicitudPendiente = armasActivas.some(arma => {
                        const solicitudesChalecos = arma.solicitudesChalecos || [];
                        return solicitudesChalecos.some(s => s && s.estado === 'pendiente');
                    });
                    
                    if (tieneArmaSinChaleco && !tieneSolicitudPendiente) {
                        seccionChaleco.style.display = 'block';
                    } else {
                        seccionChaleco.style.display = 'none';
                    }
                }
                
                mostrarArmas(armasOrdenadas);
            } catch (error) {
                console.error('Error cargando armas:', error);
            }
        }

        function mostrarArmas(armas) {
            const listaEl = document.getElementById('listaArmas');
            
            if (armas.length === 0) {
                listaEl.innerHTML = '<p style="color: #6b7280;">No tienes armas registradas</p>';
                return;
            }
            
            const esSarg = esSargentoOAdmin();
            let html = '<table class="data-table"><thead><tr><th>Tipo</th><th>' + (esSarg ? 'Prospect' : 'Sargento') + '</th><th>Balas</th><th>Chaleco</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>';
            
            armas.forEach(arma => {
                const fecha = arma.fechaCreacion?.toDate();
                const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                const estadoClass = arma.estado === 'activa' ? 'success' : 'error';
                const solicitudesPendientes = (arma.solicitudesBalas || []).filter(s => s.estado === 'pendiente');
                const balasActual = arma.cantidadBalasActual !== undefined ? arma.cantidadBalasActual : arma.cantidadBalasInicial || 0;
                const balasInicial = arma.cantidadBalasInicial || 0;
                
                html += `<tr style="${arma.estado === 'activa' ? 'background: #f0fdf4;' : 'background: #fef2f2;'}">
                    <td><strong>${arma.tipoArma}</strong></td>
                    <td>${esSarg ? arma.vendedorNombre : arma.dealerNombre}</td>
                    <td>${balasActual} / ${balasInicial}${solicitudesPendientes.length > 0 ? ` <span style="color: #f59e0b;">(${solicitudesPendientes.length} solicitud pendiente)</span>` : ''}</td>
                    <td>${arma.chaleco ? 'Sí' : 'No'}</td>
                    <td><span class="estado-badge ${estadoClass}">${arma.estado}</span></td>
                    <td>${fechaStr}</td>
                <td>
                    <button class="btn-secondary btn-sm" onclick="verDetallesArma('${arma.id}')" style="margin-right: 0.5rem;">
                        Ver Detalles
                    </button>
                    ${arma.estado === 'activa' && !esSarg ? `
                        <button class="btn-primary btn-sm" onclick="solicitarBalasModal('${arma.id}')">
                            Solicitar Balas
                        </button>
                    ` : ''}
                    ${arma.estado === 'perdida' ? `
                        <span style="color: #ef4444; font-size: 0.875rem;">${obtenerNombreMotivo(arma.motivoPerdida)}</span>
                    ` : ''}
                    ${arma.estado === 'activa' && esSarg && solicitudesPendientes.length > 0 ? `
                        <span style="color: #f59e0b; font-size: 0.875rem;">${solicitudesPendientes.length} solicitud(es) pendiente(s)</span>
                    ` : ''}
                </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            listaEl.innerHTML = html;
        }

        async function solicitarBalasModal(armaId) {
            console.log('=== SOLICITAR BALAS MODAL INICIADO ===');
            console.log('Arma ID:', armaId);
            console.log('Usuario actual:', currentUser);
            console.log('Rol del usuario:', currentUser?.rol);
            console.log('Es prospect?:', esProspect());
            
            const cantidad = prompt('Cantidad de balas a solicitar:');
            if (!cantidad || isNaN(cantidad) || parseInt(cantidad) <= 0) {
                alert('Cantidad inválida');
                return;
            }
            
            console.log('Cantidad ingresada:', cantidad);
            
            try {
                console.log('Intentando mostrar mensaje...');
                mostrarMensaje('Solicitando balas...', 'info');
                console.log('Llamando a solicitarRecargaBalas...');
                
                await solicitarRecargaBalas(armaId, parseInt(cantidad));
                
                console.log('solicitarRecargaBalas completado exitosamente');
                mostrarMensaje('Solicitud de balas enviada correctamente', 'success');
                alert('✅ Solicitud de balas enviada correctamente');
                
                // Esperar un momento para que se guarde en Firestore
                await new Promise(resolve => setTimeout(resolve, 1000));
                cargarArmas();
            } catch (error) {
                console.error('❌ ERROR solicitando balas:', error);
                console.error('Stack trace:', error.stack);
                alert('❌ Error al solicitar balas: ' + error.message + '\n\nRevisa la consola para más detalles.');
                mostrarMensaje(error.message, 'error');
            }
        }

        async function entregarBalasConfirm(armaId, solicitudIndex) {
            if (!confirm('¿Marcar esta solicitud como entregada?')) return;
            try {
                mostrarMensaje('Marcando como entregada...', 'info');
                await entregarBalas(armaId, solicitudIndex);
                mostrarMensaje('Balas marcadas como entregadas', 'success');
                cargarArmas();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        async function verDetallesArma(armaId) {
            try {
                await ensureDb();
                const armaDoc = await db.collection('entregas_armas').doc(armaId).get();
                
                if (!armaDoc.exists) {
                    alert('Arma no encontrada');
                    return;
                }
                
                const arma = { id: armaDoc.id, ...armaDoc.data() };
                const esSarg = esSargentoOAdmin();
                
                const fechaCreacion = arma.fechaCreacion?.toDate();
                const fechaCreacionStr = fechaCreacion ? fechaCreacion.toLocaleString('es-PE') : 'N/A';
                const fechaPerdida = arma.fechaPerdida?.toDate();
                const fechaPerdidaStr = fechaPerdida ? fechaPerdida.toLocaleString('es-PE') : 'N/A';
                
                // Obtener historial completo de balas y chalecos
                const solicitudesBalas = arma.solicitudesBalas || [];
                const solicitudesChalecos = arma.solicitudesChalecos || [];
                
                // Combinar todas las solicitudes con su tipo
                const todasSolicitudes = [
                    ...solicitudesBalas.map(s => ({ ...s, tipo: 'balas' })),
                    ...solicitudesChalecos.map(s => ({ ...s, tipo: 'chaleco' }))
                ].sort((a, b) => {
                    const fechaA = a.fecha?.toDate() || new Date(0);
                    const fechaB = b.fecha?.toDate() || new Date(0);
                    return fechaB - fechaA;
                });
                
                let html = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 2rem;">
                        <div style="background: white; border-radius: 0.5rem; padding: 2rem; max-width: 700px; max-height: 90vh; overflow-y: auto; width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="margin: 0;">Detalles del Arma</h2>
                                <button onclick="cerrarModalDetallesArma()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;">Cerrar</button>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="margin: 0 0 0.5rem 0;">${arma.tipoArma} ${arma.chaleco ? '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; margin-left: 0.5rem;">Con Chaleco</span>' : ''}</h3>
                                <p><strong>${esSarg ? 'Prospect' : 'Sargento'}:</strong> ${esSarg ? arma.vendedorNombre : arma.dealerNombre}</p>
                                <p><strong>Estado:</strong> <span class="estado-badge ${arma.estado === 'activa' ? 'success' : 'error'}">${arma.estado}</span></p>
                                <p><strong>Fecha de entrega:</strong> ${fechaCreacionStr}</p>
                                <p><strong>Balas iniciales:</strong> ${arma.cantidadBalasInicial || 0}</p>
                                <p><strong>Balas actuales:</strong> <strong style="color: #10b981;">${arma.cantidadBalasActual !== undefined ? arma.cantidadBalasActual : arma.cantidadBalasInicial || 0}</strong></p>
                                ${arma.estado === 'perdida' ? `
                                    <p><strong>Motivo de pérdida:</strong> ${obtenerNombreMotivo(arma.motivoPerdida)}</p>
                                    <p><strong>Fecha de pérdida:</strong> ${fechaPerdidaStr}</p>
                                ` : ''}
                            </div>
                            
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                                <h4 style="margin: 0 0 1rem 0;">Historial Completo de Solicitudes (Balas y Chalecos)</h4>
                                ${todasSolicitudes.length > 0 ? `
                                    <div style="display: grid; gap: 0.75rem;">
                                        ${todasSolicitudes.map(solicitud => {
                                            const fechaSolicitud = solicitud.fecha?.toDate();
                                            const fechaSolicitudStr = fechaSolicitud ? fechaSolicitud.toLocaleString('es-PE') : 'N/A';
                                            const fechaConfirmacion = solicitud.fechaConfirmacion?.toDate();
                                            const fechaConfirmacionStr = fechaConfirmacion ? fechaConfirmacion.toLocaleString('es-PE') : 'N/A';
                                            const fechaRechazo = solicitud.fechaRechazo?.toDate();
                                            const fechaRechazoStr = fechaRechazo ? fechaRechazo.toLocaleString('es-PE') : 'N/A';
                                            
                                            let bgColor = '#f9fafb';
                                            let borderColor = '#e5e7eb';
                                            let estadoTexto = 'Pendiente';
                                            let estadoColor = '#f59e0b';
                                            
                                            if (solicitud.estado === 'entregada') {
                                                bgColor = '#f0fdf4';
                                                borderColor = '#10b981';
                                                estadoTexto = 'Entregada';
                                                estadoColor = '#10b981';
                                            } else if (solicitud.estado === 'rechazada') {
                                                bgColor = '#fef2f2';
                                                borderColor = '#ef4444';
                                                estadoTexto = 'Rechazada';
                                                estadoColor = '#ef4444';
                                            }
                                            
                                            const tipoTexto = solicitud.tipo === 'chaleco' ? 'Chaleco' : `${solicitud.cantidad || 0} balas`;
                                            
                                            return `
                                                <div style="background: ${bgColor}; padding: 1rem; border-radius: 0.375rem; border-left: 4px solid ${borderColor};">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                        <p style="margin: 0;"><strong>Tipo:</strong> ${tipoTexto}</p>
                                                        <span style="background: ${estadoColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 500;">${estadoTexto}</span>
                                                    </div>
                                                    <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;"><strong>Solicitado:</strong> ${fechaSolicitudStr}</p>
                                                    ${solicitud.estado === 'entregada' ? `
                                                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;"><strong>Confirmado por:</strong> ${solicitud.sargentoNombre || 'N/A'}</p>
                                                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;"><strong>Fecha de confirmación:</strong> ${fechaConfirmacionStr}</p>
                                                    ` : ''}
                                                    ${solicitud.estado === 'rechazada' ? `
                                                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;"><strong>Rechazado por:</strong> ${solicitud.sargentoNombreRechazo || 'N/A'}</p>
                                                        <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;"><strong>Fecha de rechazo:</strong> ${fechaRechazoStr}</p>
                                                        ${solicitud.motivoRechazo ? `
                                                            <p style="margin: 0.25rem 0 0 0; color: #ef4444; font-size: 0.875rem;"><strong>Motivo:</strong> ${solicitud.motivoRechazo}</p>
                                                        ` : ''}
                                                    ` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <p style="color: #6b7280;">No hay solicitudes registradas</p>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                // Crear modal si no existe
                let modal = document.getElementById('modalDetallesArma');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'modalDetallesArma';
                    document.body.appendChild(modal);
                }
                modal.innerHTML = html;
            } catch (error) {
                console.error('Error cargando detalles del arma:', error);
                alert('Error cargando detalles: ' + error.message);
            }
        }
        
        function cerrarModalDetallesArma() {
            const modal = document.getElementById('modalDetallesArma');
            if (modal) {
                modal.remove();
            }
        }

        async function marcarPerdidaModal(armaId) {
            const motivo = prompt(`Motivo de pérdida:\n1. robo_corte\n2. enfrentamiento\n3. policia\n4. full_muerte\n5. bug\n\nIngresa el valor:`);
            if (!motivo) return;
            
            const motivosValidos = MOTIVOS_PERDIDA.map(m => m.valor);
            if (!motivosValidos.includes(motivo)) {
                alert('Motivo inválido. Usa uno de: robo_corte, enfrentamiento, policia, full_muerte, bug');
                return;
            }
            
            try {
                mostrarMensaje('Marcando arma como perdida...', 'info');
                await marcarArmaPerdida(armaId, motivo);
                mostrarMensaje('Arma marcada como perdida', 'success');
                cargarArmas();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        function mostrarMensaje(mensaje, tipo) {
            const mensajeEl = document.getElementById('mensajeArma');
            if (!mensajeEl) return;
            mensajeEl.textContent = mensaje;
            mensajeEl.className = `auth-message ${tipo}`;
            mensajeEl.style.display = 'block';
            setTimeout(() => {
                mensajeEl.style.display = 'none';
            }, 3000);
        }

        async function solicitarChalecoGlobal() {
            if (!esProspect()) {
                alert('Solo los prospects pueden solicitar chalecos');
                return;
            }
            
            try {
                await ensureDb();
                // Buscar todas las armas activas del usuario sin chaleco
                const armas = await obtenerArmasPorVendedor(currentUser.id);
                const armasActivasSinChaleco = armas.filter(a => a.estado === 'activa' && !a.chaleco);
                
                if (armasActivasSinChaleco.length === 0) {
                    alert('No tienes armas activas sin chaleco para solicitar');
                    return;
                }
                
                // Verificar si ya hay una solicitud pendiente
                const tieneSolicitudPendiente = armasActivasSinChaleco.some(arma => {
                    const solicitudesChalecos = arma.solicitudesChalecos || [];
                    return solicitudesChalecos.some(s => s && s.estado === 'pendiente');
                });
                
                if (tieneSolicitudPendiente) {
                    alert('Ya tienes una solicitud de chaleco pendiente');
                    return;
                }
                
                // Si hay solo una arma, solicitar directamente
                if (armasActivasSinChaleco.length === 1) {
                    if (!confirm('¿Deseas solicitar un chaleco?')) return;
                    await solicitarChaleco(armasActivasSinChaleco[0].id);
                    alert('Solicitud de chaleco enviada correctamente');
                    cargarArmas();
                } else {
                    // Si hay varias, mostrar selector
                    const opciones = armasActivasSinChaleco.map((a, i) => `${i + 1}. ${a.tipoArma}`).join('\n');
                    const seleccion = prompt(`Tienes ${armasActivasSinChaleco.length} armas sin chaleco:\n${opciones}\n\nIngresa el número del arma (1-${armasActivasSinChaleco.length}):`);
                    const indice = parseInt(seleccion) - 1;
                    
                    if (isNaN(indice) || indice < 0 || indice >= armasActivasSinChaleco.length) {
                        alert('Selección inválida');
                        return;
                    }
                    
                    if (!confirm('¿Deseas solicitar un chaleco para esta arma?')) return;
                    await solicitarChaleco(armasActivasSinChaleco[indice].id);
                    alert('Solicitud de chaleco enviada correctamente');
                    cargarArmas();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Inicializar
        if (esSargento()) {
            cargarProspectsArmas();
            // Mostrar formulario de creación para sargentos
            const formularioCrearArma = document.getElementById('formularioCrearArma');
            if (formularioCrearArma) {
                formularioCrearArma.style.display = 'block';
            }
        }
        cargarArmas();
    </script>
</body>
</html>

