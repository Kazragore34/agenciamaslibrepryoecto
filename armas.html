<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armas - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-fichaje.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="stats-container">
        <div class="fichaje-header">
            <h1>Mis Armas</h1>
            <div>
                <a href="menu.html" class="btn-primary">Menú</a>
                <a href="tickets_dinero.html" class="btn-primary">Tickets</a>
                <a href="armas.html" class="btn-primary">Armas</a>
                <a href="estadisticas.html" class="btn-primary">Estadísticas</a>
                <a id="btnPanelAdmin" href="admin.html" class="btn-primary" style="display: none;">Admin</a>
                <a id="btnEntregas" href="entregas.html" class="btn-primary" style="display: none;">Entregas</a>
                <a href="perfil.html" class="btn-primary" style="background: #6b7280;">Mi Perfil</a>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Lista de armas (activas y perdidas) -->
        <div style="margin-top: 2rem;">
            <div class="stats-card">
                <h3>Historial de Armas</h3>
                <p style="color: #6b7280; margin-bottom: 1rem;">Todas las armas que has recibido (activas y perdidas). Haz click en "Solicitar Balas" para solicitar más balas en armas activas.</p>
                <div id="listaArmas">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="crypto-utils.js"></script>
    <script src="auth.js"></script>
    <script src="admin.js"></script>
    <script src="productos.js"></script>
    <script src="metas.js"></script>
    <script src="armas.js"></script>
    <script>
        requireAuth();
        
        const currentUser = getCurrentUser();
        
        // Actualizar navegación según rol
        function actualizarNavegacion() {
            const btnPanelAdmin = document.getElementById('btnPanelAdmin');
            const btnEntregas = document.getElementById('btnEntregas');
            
            if (esDealer()) {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'inline-block';
                if (btnEntregas) btnEntregas.style.display = 'inline-block';
            } else {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'none';
                if (btnEntregas) btnEntregas.style.display = 'none';
            }
        }
        
        actualizarNavegacion();

        // Cargar todas las armas (activas y perdidas)
        async function cargarArmas() {
            try {
                // Todos los usuarios ven las armas que recibieron (activas y perdidas)
                const armas = await obtenerArmasPorVendedor(currentUser.id);
                
                // Ordenar: primero activas, luego perdidas
                const armasActivas = armas.filter(a => a.estado === 'activa');
                const armasPerdidas = armas.filter(a => a.estado === 'perdida');
                
                // Ordenar por fecha (más recientes primero)
                const ordenarPorFecha = (a, b) => {
                    const fechaA = a.fechaCreacion?.toDate() || new Date(0);
                    const fechaB = b.fechaCreacion?.toDate() || new Date(0);
                    return fechaB - fechaA;
                };
                
                armasActivas.sort(ordenarPorFecha);
                armasPerdidas.sort(ordenarPorFecha);
                
                const armasOrdenadas = [...armasActivas, ...armasPerdidas];
                
                mostrarArmas(armasOrdenadas);
            } catch (error) {
                console.error('Error cargando armas:', error);
            }
        }

        function mostrarArmas(armas) {
            const listaEl = document.getElementById('listaArmas');
            
            if (armas.length === 0) {
                listaEl.innerHTML = '<p style="color: #6b7280;">No tienes armas registradas</p>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Tipo</th><th>Dealer</th><th>Balas</th><th>Chaleco</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>';
            
            armas.forEach(arma => {
                const fecha = arma.fechaCreacion?.toDate();
                const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                const estadoClass = arma.estado === 'activa' ? 'success' : 'error';
                const solicitudesPendientes = (arma.solicitudesBalas || []).filter(s => s.estado === 'pendiente');
                const balasActual = arma.cantidadBalasActual !== undefined ? arma.cantidadBalasActual : arma.cantidadBalasInicial || 0;
                const balasInicial = arma.cantidadBalasInicial || 0;
                
                html += `<tr style="${arma.estado === 'activa' ? 'background: #f0fdf4;' : 'background: #fef2f2;'}">
                    <td><strong>${arma.tipoArma}</strong></td>
                    <td>${arma.dealerNombre}</td>
                    <td>${balasActual} / ${balasInicial}${solicitudesPendientes.length > 0 ? ` <span style="color: #f59e0b;">(${solicitudesPendientes.length} solicitud pendiente)</span>` : ''}</td>
                    <td>${arma.chaleco ? 'Sí' : 'No'}</td>
                    <td><span class="estado-badge ${estadoClass}">${arma.estado}</span></td>
                    <td>${fechaStr}</td>
                    <td>
                        ${arma.estado === 'activa' ? `
                            <button class="btn-primary btn-sm" onclick="solicitarBalasModal('${arma.id}')" style="margin-right: 0.5rem;">
                                Solicitar Balas
                            </button>
                        ` : `
                            <span style="color: #ef4444; font-size: 0.875rem;">${obtenerNombreMotivo(arma.motivoPerdida)}</span>
                        `}
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            listaEl.innerHTML = html;
        }

        async function solicitarBalasModal(armaId) {
            const cantidad = prompt('Cantidad de balas a solicitar:');
            if (!cantidad || isNaN(cantidad) || parseInt(cantidad) <= 0) {
                alert('Cantidad inválida');
                return;
            }
            
            try {
                mostrarMensaje('Solicitando balas...', 'info');
                await solicitarRecargaBalas(armaId, parseInt(cantidad));
                mostrarMensaje('Solicitud de balas enviada', 'success');
                cargarArmas();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        async function entregarBalasConfirm(armaId, solicitudIndex) {
            if (!confirm('¿Marcar esta solicitud como entregada?')) return;
            try {
                mostrarMensaje('Marcando como entregada...', 'info');
                await entregarBalas(armaId, solicitudIndex);
                mostrarMensaje('Balas marcadas como entregadas', 'success');
                cargarArmas();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        async function marcarPerdidaModal(armaId) {
            const motivo = prompt(`Motivo de pérdida:\n1. robo_corte\n2. enfrentamiento\n3. policia\n4. full_muerte\n5. bug\n\nIngresa el valor:`);
            if (!motivo) return;
            
            const motivosValidos = MOTIVOS_PERDIDA.map(m => m.valor);
            if (!motivosValidos.includes(motivo)) {
                alert('Motivo inválido. Usa uno de: robo_corte, enfrentamiento, policia, full_muerte, bug');
                return;
            }
            
            try {
                mostrarMensaje('Marcando arma como perdida...', 'info');
                await marcarArmaPerdida(armaId, motivo);
                mostrarMensaje('Arma marcada como perdida', 'success');
                cargarArmas();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        function mostrarMensaje(mensaje, tipo) {
            const mensajeEl = document.getElementById('mensajeArma');
            mensajeEl.textContent = mensaje;
            mensajeEl.className = `auth-message ${tipo}`;
            mensajeEl.style.display = 'block';
            setTimeout(() => {
                mensajeEl.style.display = 'none';
            }, 3000);
        }


        // Inicializar
        cargarArmas();
    </script>
</body>
</html>

