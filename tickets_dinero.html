<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tickets de Dinero - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-fichaje.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="stats-container">
        <div class="fichaje-header">
            <h1>Tickets de Dinero</h1>
            <div>
                <a href="menu.html" class="btn-primary">Menú</a>
                <a href="tickets_dinero.html" class="btn-primary">Tickets</a>
                <a href="armas.html" class="btn-primary">Armas</a>
                <a href="estadisticas.html" class="btn-primary">Estadísticas</a>
                <a id="btnPanelAdmin" href="admin.html" class="btn-primary" style="display: none;">Admin</a>
                <a id="btnEntregas" href="entregas.html" class="btn-primary" style="display: none;">Entregas</a>
                <a id="btnPerdidas" href="perdidas.html" class="btn-primary" style="display: none; background: #ef4444;">Pérdidas</a>
                <a href="perfil.html" class="btn-primary" style="background: #6b7280;">Mi Perfil</a>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Formulario de creación de entrega de productos (solo para sargentos) -->
        <div id="formularioCrearEntrega" class="seccion-sargento" style="margin-top: 2rem; display: none;">
            <div class="stats-card">
                <h2>Crear Nueva Entrega de Productos</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Crea una entrega de productos para un prospect. Después de que el prospect confirme, podrá crear un ticket de dinero.</p>
                <div id="mensajeEntrega" class="auth-message" style="display: none;"></div>
                <form id="formCrearEntrega">
                    <div class="form-group">
                        <label for="prospectSelectEntrega">Prospect</label>
                        <select id="prospectSelectEntrega" required>
                            <option value="">Seleccionar prospect...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Productos</label>
                        <div id="productosList">
                            <div class="producto-item">
                                <select class="producto-tipo" required>
                                    <option value="">Seleccionar producto...</option>
                                    <option value="coca">Coca</option>
                                    <option value="meta">Meta</option>
                                    <option value="crack">Crack</option>
                                    <option value="weed">Weed</option>
                                    <option value="semilla_maleza">Semilla Maleza</option>
                                    <option value="semilla_amarillo">Semilla Amarillo</option>
                                    <option value="semilla_azul">Semilla Azul</option>
                                    <option value="semilla_morado">Semilla Morado</option>
                                </select>
                                <input type="number" class="producto-cantidad" min="1" value="1" required>
                                <button type="button" class="btn-remove" onclick="eliminarProducto(this)">Eliminar</button>
                            </div>
                        </div>
                        <button type="button" class="btn-secondary" onclick="agregarProducto()">+ Agregar Producto</button>
                    </div>

                    <div class="form-group">
                        <label>Items Adicionales (para semillas)</label>
                        <div id="itemsAdicionalesList">
                            <p style="color: #6b7280; font-size: 0.875rem;">Se agregarán automáticamente cuando selecciones semillas</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notasEntrega">Notas (opcional)</label>
                        <textarea id="notasEntrega" rows="3"></textarea>
                    </div>

                    <div id="precioAprox" class="precio-aprox" style="display: none; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem; margin: 1rem 0;">
                        <strong>Precio Aproximado: $<span id="precioAproxValor">0</span></strong>
                        <p style="color: #6b7280; font-size: 0.875rem; margin: 0.5rem 0 0 0;">Este precio es solo una estimación para tu referencia</p>
                        <p id="notaBrotes" style="color: #059669; font-size: 0.875rem; margin: 0.5rem 0 0 0; display: none;"><strong>Nota:</strong> Las semillas se venden como brotes. 1 semilla = 10 brotes. El precio mostrado es por brote.</p>
                    </div>

                    <button type="submit" class="btn-primary">Crear Entrega</button>
                </form>
            </div>
        </div>

        <!-- Sección de entregas pendientes (para confirmar/rechazar) -->
        <div id="seccionEntregasPendientes" style="margin-top: 2rem; display: none;">
            <div class="stats-card">
                <h3>Entrega Pendiente de Confirmar</h3>
                <div id="detalleEntregaPendiente">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Lista de entregas pendientes (para vendedores) -->
        <div id="seccionListaEntregasPendientes" style="margin-top: 2rem;">
            <div class="stats-card">
                <h3>Entregas Pendientes de Confirmar</h3>
                <div id="listaEntregasPendientes">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Lista de entregas confirmadas (para vendedores - crear tickets) -->
        <div id="seccionEntregasConfirmadasVendedor" style="margin-top: 2rem;">
            <div class="stats-card">
                <h3>Entregas Confirmadas - Crear Ticket de Dinero</h3>
                <p style="color: #6b7280; margin-bottom: 1rem;">Selecciona una entrega confirmada para crear un ticket de dinero y registrar el monto que entregaste. El ticket quedará pendiente hasta que el sargento confirme la cantidad.</p>
                <div id="listaEntregasConfirmadasVendedor">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Sección DEPOSITO (para prospect y sargentos) -->
        <div id="seccionDeposito" style="margin-top: 2rem; display: none;">
            <div class="stats-card">
                <h2>DEPOSITO</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Registra el dinero negro proveniente de otras actividades. Los depósitos quedarán pendientes hasta que un sargento los apruebe.</p>
                
                <div id="mensajeDeposito" class="auth-message" style="display: none;"></div>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label for="sargentoSelectDeposito" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Seleccionar Sargento:</label>
                        <select id="sargentoSelectDeposito" class="form-control" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            <option value="">Cargando sargentos...</option>
                        </select>
                    </div>
                    <h3 style="margin-bottom: 1rem;">DINERO PROVENIENTE DE...</h3>
                    <div id="listaDineroNegro">
                        <!-- Se carga dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección: Depósitos Pendientes (para prospects) -->
        <div id="seccionDepositosPendientesProspect" style="margin-top: 2rem; display: none;">
            <div class="stats-card">
                <h2>Mis Depósitos Pendientes</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Aquí puedes ver el estado de los depósitos de dinero negro que has registrado. Quedarán pendientes hasta que un sargento los apruebe.</p>
                <div id="listaDepositosPendientesProspect">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Sección MESAS (para prospect y sargentos) -->
        <div id="seccionMesas" style="margin-top: 2rem; display: none;">
            <div class="stats-card">
                <h2>MESAS</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Sección para farmear (próximamente).</p>
                <div id="contenidoMesas">
                    <!-- Se cargará dinámicamente en el futuro -->
                </div>
            </div>
        </div>

        <!-- Lista de tickets -->
        <div style="margin-top: 2rem;">
            <div class="stats-card">
                <h3 id="tituloTickets">Mis Tickets</h3>
                <div id="listaTickets">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="crypto-utils.js"></script>
    <script src="auth.js"></script>
    <script src="admin.js"></script>
    <script src="productos.js"></script>
    <script src="metas.js"></script>
    <script src="entregas.js"></script>
    <script src="tickets.js"></script>
    <script>
        requireAuth();
        
        const currentUser = getCurrentUser();
        let todosVendedores = [];
        let entregasConfirmadas = [];
        
        // Objeto para almacenar los importes de dinero negro temporalmente
        // Declarado al inicio para que esté disponible en todas las funciones
        let dineroNegroTemp = {};
        
        // Función para cargar entrega pendiente
        async function cargarEntregaPendiente(entregaId) {
            try {
                await ensureDb();
                const entregaDoc = await db.collection('entregas_productos').doc(entregaId).get();
                
                if (!entregaDoc.exists) {
                    mostrarMensaje('Entrega no encontrada', 'error');
                    return;
                }
                
                const entrega = { id: entregaDoc.id, ...entregaDoc.data() };
                
                // Verificar que el usuario actual es el vendedor
                if (entrega.vendedorId !== currentUser.id) {
                    mostrarMensaje('No tienes permiso para ver esta entrega', 'error');
                    return;
                }
                
                // Verificar que esté pendiente
                if (entrega.estado !== 'pendiente') {
                    mostrarMensaje('Esta entrega ya fue procesada', 'info');
                    window.location.href = 'tickets_dinero.html';
                    return;
                }
                
                // Mostrar sección de entrega pendiente
                document.getElementById('seccionEntregasPendientes').style.display = 'block';
                // Formulario de creación ya no existe aquí
                document.getElementById('listaTickets').parentElement.parentElement.style.display = 'none';
                
                const fecha = entrega.fechaCreacion?.toDate();
                const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'Fecha no disponible';
                
                let html = `
                    <div style="padding: 1rem; background: #fef3c7; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="margin-top: 0;">Entrega de Productos</h4>
                        <p><strong>De:</strong> ${entrega.dealerNombre}</p>
                        <p><strong>Fecha:</strong> ${fechaStr}</p>
                        <div style="margin: 1rem 0;">
                            <strong>Productos:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                ${entrega.productos.map(p => `<li>${obtenerNombreProducto(p.tipo)}: ${p.cantidad}</li>`).join('')}
                            </ul>
                        </div>
                        ${entrega.itemsAdicionales && entrega.itemsAdicionales.length > 0 ? `
                            <div style="margin: 1rem 0;">
                                <strong>Items Adicionales:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${entrega.itemsAdicionales.map(i => `<li>${i.tipo}: ${i.cantidad}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${entrega.notas ? `<p><strong>Notas:</strong> ${entrega.notas}</p>` : ''}
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                            <button class="btn-success" onclick="confirmarEntregaDesdeTicket('${entrega.id}')">Confirmar Entrega</button>
                            <button class="btn-danger" onclick="rechazarEntregaDesdeTicket('${entrega.id}')">Rechazar Entrega</button>
                            <button class="btn-secondary" onclick="window.location.href='tickets_dinero.html'">Cancelar</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('detalleEntregaPendiente').innerHTML = html;
            } catch (error) {
                console.error('Error cargando entrega:', error);
                mostrarMensaje('Error cargando entrega: ' + error.message, 'error');
            }
        }
        
        async function confirmarEntregaDesdeTicket(entregaId) {
            if (!confirm('¿Confirmas que recibiste esta entrega?')) return;
            try {
                mostrarMensaje('Confirmando entrega...', 'info');
                await confirmarEntrega(entregaId);
                mostrarMensaje('Entrega confirmada correctamente', 'success');
                setTimeout(() => {
                    window.location.href = 'tickets_dinero.html';
                }, 1500);
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }
        
        async function rechazarEntregaDesdeTicket(entregaId) {
            const motivo = prompt('Motivo del rechazo:');
            if (!motivo) return;
            try {
                mostrarMensaje('Rechazando entrega...', 'info');
                await rechazarEntrega(entregaId, motivo);
                mostrarMensaje('Entrega rechazada', 'info');
                setTimeout(() => {
                    window.location.href = 'tickets_dinero.html';
                }, 1500);
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }
        
        // Cargar entregas pendientes del prospect (o sargento que también vende)
        async function cargarListaEntregasPendientes() {
            // Sargentos también pueden recibir entregas, así que no ocultar
            
            try {
                console.log('Cargando entregas pendientes para:', currentUser.id);
                const entregas = await obtenerEntregasPendientesVendedor(currentUser.id);
                console.log('Entregas pendientes encontradas:', entregas.length);
                const listaEl = document.getElementById('listaEntregasPendientes');
                
                if (!listaEl) {
                    console.error('Elemento listaEntregasPendientes no encontrado');
                    return;
                }
                
                if (entregas.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay entregas pendientes</p>';
                    return;
                }
                
                let html = '<div class="entregas-list">';
                entregas.forEach(entrega => {
                    const fecha = entrega.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'Fecha no disponible';
                    
                    html += `
                        <div class="entrega-item" style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background: #fef3c7;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <strong>De: ${entrega.dealerNombre}</strong>
                                    <p style="margin: 0.25rem 0; color: #6b7280;">${fechaStr}</p>
                                </div>
                                <span class="estado-badge pendiente">Pendiente</span>
                            </div>
                            <div style="margin: 0.5rem 0;">
                                <strong>Productos:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${entrega.productos.map(p => `<li>${obtenerNombreProducto(p.tipo)}: ${p.cantidad}</li>`).join('')}
                                </ul>
                            </div>
                            ${entrega.itemsAdicionales && entrega.itemsAdicionales.length > 0 ? `
                                <div style="margin: 0.5rem 0;">
                                    <strong>Items Adicionales:</strong>
                                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                                        ${entrega.itemsAdicionales.map(i => `<li>${i.tipo}: ${i.cantidad}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn-success btn-sm" onclick="confirmarEntregaDesdeLista('${entrega.id}')">Confirmar</button>
                                <button class="btn-danger btn-sm" onclick="rechazarEntregaDesdeLista('${entrega.id}')">Rechazar</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando entregas pendientes:', error);
            }
        }

        async function confirmarEntregaDesdeLista(entregaId) {
            if (!confirm('¿Confirmas que recibiste esta entrega?')) return;
            try {
                mostrarMensaje('Confirmando entrega...', 'info');
                await confirmarEntrega(entregaId);
                mostrarMensaje('Entrega confirmada correctamente', 'success');
                cargarListaEntregasPendientes();
                cargarEntregasConfirmadasVendedor();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        async function rechazarEntregaDesdeLista(entregaId) {
            const motivo = prompt('Motivo del rechazo:');
            if (!motivo) return;
            try {
                mostrarMensaje('Rechazando entrega...', 'info');
                await rechazarEntrega(entregaId, motivo);
                mostrarMensaje('Entrega rechazada', 'info');
                cargarListaEntregasPendientes();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        // Cargar entregas confirmadas del prospect (o sargento que también vende)
        async function cargarEntregasConfirmadasVendedor() {
            // Sargentos también pueden recibir entregas y crear tickets, así que no ocultar
            
            try {
                console.log('Cargando entregas confirmadas para:', currentUser.id);
                const entregas = await obtenerEntregasPorVendedor(currentUser.id);
                console.log('Total entregas encontradas:', entregas.length);
                console.log('Estados de entregas:', entregas.map(e => ({ id: e.id, estado: e.estado, dealerNombre: e.dealerNombre })));
                const entregasConfirmadas = entregas.filter(e => e.estado === 'confirmado');
                console.log('Entregas confirmadas filtradas:', entregasConfirmadas.length);
                console.log('Mostrando entregas confirmadas:', entregasConfirmadas);
                const listaEl = document.getElementById('listaEntregasConfirmadasVendedor');
                
                if (!listaEl) {
                    console.error('Elemento listaEntregasConfirmadasVendedor no encontrado');
                    return;
                }
                
                if (entregasConfirmadas.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay entregas confirmadas. Primero debes confirmar las entregas pendientes.</p>';
                    return;
                }
                
                // Obtener todos los tickets para verificar cuáles entregas ya tienen ticket CONFIRMADO
                const tickets = await obtenerTicketsPorVendedor(currentUser.id);
                const entregasConTicketConfirmado = new Set();
                const entregasConTicketRechazado = new Set();
                
                tickets.forEach(ticket => {
                    if (ticket.entregasRelacionadas && ticket.entregasRelacionadas.length > 0) {
                        ticket.entregasRelacionadas.forEach(eId => {
                            // Si el ticket está confirmado, la entrega no puede tener más tickets
                            if (ticket.estado === 'confirmado') {
                                entregasConTicketConfirmado.add(eId);
                            }
                            // Si el ticket está rechazado, se puede crear uno nuevo
                            if (ticket.estado === 'rechazado') {
                                entregasConTicketRechazado.add(eId);
                            }
                        });
                    }
                });
                
                let html = '<table class="data-table"><thead><tr><th>Sargento</th><th>Productos</th><th>Fecha</th><th>Estado</th><th>Acción</th></tr></thead><tbody>';
                
                entregasConfirmadas.forEach(entrega => {
                    const fecha = entrega.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                    const tieneTicketConfirmado = entregasConTicketConfirmado.has(entrega.id);
                    const tieneTicketRechazado = entregasConTicketRechazado.has(entrega.id);
                    
                    // Buscar el ticket más reciente para esta entrega para mostrar su estado
                    const ticketReciente = tickets
                        .filter(t => t.entregasRelacionadas && t.entregasRelacionadas.includes(entrega.id))
                        .sort((a, b) => {
                            const fechaA = a.fechaCreacion?.toDate() || new Date(0);
                            const fechaB = b.fechaCreacion?.toDate() || new Date(0);
                            return fechaB - fechaA;
                        })[0];
                    
                    let estadoTicket = '';
                    if (tieneTicketConfirmado && ticketReciente) {
                        estadoTicket = `<span class="estado-badge success">Confirmado</span>`;
                    } else if (tieneTicketRechazado && ticketReciente) {
                        estadoTicket = `<span class="estado-badge error">Rechazado</span>`;
                    } else if (ticketReciente && ticketReciente.estado === 'pendiente_dealer') {
                        estadoTicket = `<span class="estado-badge pendiente">Pendiente de confirmación</span>`;
                    } else {
                        estadoTicket = '<span style="color: #6b7280;">Sin ticket</span>';
                    }
                    
                    html += `<tr>
                        <td>${entrega.dealerNombre}</td>
                        <td>${entrega.productos.map(p => `${obtenerNombreProducto(p.tipo)}: ${p.cantidad}`).join(', ')}</td>
                        <td>${fechaStr}</td>
                        <td>${estadoTicket}</td>
                        <td>
                            ${tieneTicketConfirmado ? `
                                <span style="color: #10b981; font-weight: 500;">✓ Ticket confirmado - No se puede modificar</span>
                            ` : tieneTicketRechazado ? `
                                <button class="btn-primary btn-sm" onclick="crearTicketDesdeEntrega('${entrega.id}', '${entrega.dealerId}')">
                                    Crear Nuevo Ticket
                                </button>
                                <span style="color: #6b7280; font-size: 0.875rem; margin-left: 0.5rem;">(El anterior fue rechazado)</span>
                            ` : ticketReciente && ticketReciente.estado === 'pendiente_dealer' ? `
                                <span style="color: #f59e0b; font-weight: 500;">Esperando confirmación del sargento</span>
                            ` : `
                                <button class="btn-primary btn-sm" onclick="crearTicketDesdeEntrega('${entrega.id}', '${entrega.dealerId}')">
                                    Crear Ticket de Dinero
                                </button>
                            `}
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando entregas confirmadas:', error);
            }
        }

        async function crearTicketDesdeEntrega(entregaId, dealerId) {
            // Obtener la entrega para obtener el monto aprox
            try {
                await ensureDb();
                const entregaDoc = await db.collection('entregas_productos').doc(entregaId).get();
                if (!entregaDoc.exists) {
                    alert('Entrega no encontrada');
                    return;
                }
                const entrega = entregaDoc.data();
                const montoAprox = entrega.precioAprox || null;
                
                const monto = prompt('Ingresa el monto que entregaste por esta venta:');
                if (!monto || isNaN(monto) || parseFloat(monto) <= 0) {
                    alert('Monto inválido');
                    return;
                }
                
                mostrarMensaje('Creando ticket...', 'info');
                // Los prospects pueden crear tickets para sí mismos
                const ticketId = await crearTicketDineroVendedorConAprox(dealerId, currentUser.id, parseFloat(monto), montoAprox, [entregaId]);
                mostrarMensaje('Ticket creado y confirmado correctamente', 'success');
                cargarEntregasConfirmadasVendedor();
                cargarTickets();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        // Verificar si hay parámetro de entrega en la URL
        const urlParams = new URLSearchParams(window.location.search);
        const entregaId = urlParams.get('entrega');
        
        // Inicializar siempre, independientemente del parámetro
        if (entregaId) {
            cargarEntregaPendiente(entregaId);
        } else {
            // Cargar según rol
            if (esSargentoOAdmin()) {
                // Sargentos y admins: pueden crear entregas de productos Y también venden (ven todo lo que ve un prospect)
                cargarProspects();
                const formularioCrearEntrega = document.getElementById('formularioCrearEntrega');
                if (formularioCrearEntrega) {
                    formularioCrearEntrega.style.display = 'block';
                }
                // También cargar entregas pendientes y confirmadas para que puedan vender
                cargarListaEntregasPendientes();
                cargarEntregasConfirmadasVendedor();
                // Mostrar secciones DEPOSITO y MESAS
                document.getElementById('seccionDeposito').style.display = 'block';
                document.getElementById('seccionMesas').style.display = 'block';
                cargarSargentosDeposito();
                cargarDineroNegro();
            } else if (esProspect()) {
                // Prospects: pueden confirmar entregas y crear tickets
                const formularioCrearEntrega = document.getElementById('formularioCrearEntrega');
                if (formularioCrearEntrega) {
                    formularioCrearEntrega.style.display = 'none';
                }
                document.getElementById('seccionListaEntregasPendientes').style.display = 'block';
                document.getElementById('seccionEntregasConfirmadasVendedor').style.display = 'block';
                cargarListaEntregasPendientes();
                cargarEntregasConfirmadasVendedor();
                // Mostrar secciones DEPOSITO, DEPOSITOS PENDIENTES y MESAS
                document.getElementById('seccionDeposito').style.display = 'block';
                document.getElementById('seccionDepositosPendientesProspect').style.display = 'block';
                document.getElementById('seccionMesas').style.display = 'block';
                cargarSargentosDeposito();
                cargarDineroNegro();
                cargarDepositosPendientesProspect();
            }
            cargarTickets();
        }
        
        // Forzar recarga después de un pequeño delay para asegurar que todo esté cargado
        setTimeout(() => {
            if ((esProspect() || esSargentoOAdmin()) && !entregaId) {
                cargarListaEntregasPendientes();
                cargarEntregasConfirmadasVendedor();
            }
        }, 500);

        // Cargar prospects para el formulario de entrega de productos
        async function cargarProspects() {
            if (!esSargentoOAdmin()) return;
            
            try {
                await ensureDb();
                const snapshot = await db.collection('users')
                    .orderBy('nombre')
                    .get();
                
                const currentUser = getCurrentUser();
                // Filtrar solo prospects (excluir sargentos, admins y el usuario actual)
                const prospects = snapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .filter(user => 
                        user.id !== currentUser.id && 
                        user.rol === 'prospect' // Solo mostrar prospects
                    );
                
                const select = document.getElementById('prospectSelectEntrega');
                if (!select) return;
                
                select.innerHTML = '<option value="">Seleccionar prospect...</option>';
                
                if (prospects.length === 0) {
                    select.innerHTML = '<option value="">No hay prospects disponibles</option>';
                    return;
                }
                
                prospects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.nombre} ${p.apellido} (${p.username})`;
                    select.appendChild(option);
                });
                
                console.log('Prospects cargados:', prospects.length);
            } catch (error) {
                console.error('Error cargando prospects:', error);
                const select = document.getElementById('prospectSelectEntrega');
                if (select) {
                    select.innerHTML = '<option value="">Error cargando prospects</option>';
                }
            }
        }

        // Agregar producto al formulario
        function agregarProducto() {
            const productosList = document.getElementById('productosList');
            if (!productosList) return;
            
            const nuevoProducto = document.createElement('div');
            nuevoProducto.className = 'producto-item';
            nuevoProducto.innerHTML = `
                <select class="producto-tipo" required>
                    <option value="">Seleccionar producto...</option>
                    <option value="coca">Coca</option>
                    <option value="meta">Meta</option>
                    <option value="crack">Crack</option>
                    <option value="weed">Weed</option>
                    <option value="semilla_maleza">Semilla Maleza</option>
                    <option value="semilla_amarillo">Semilla Amarillo</option>
                    <option value="semilla_azul">Semilla Azul</option>
                    <option value="semilla_morado">Semilla Morado</option>
                </select>
                <input type="number" class="producto-cantidad" min="1" value="1" required>
                <button type="button" class="btn-remove" onclick="eliminarProducto(this)">Eliminar</button>
            `;
            productosList.appendChild(nuevoProducto);
            actualizarPrecioAprox();
            actualizarItemsAdicionales();
            
            // Agregar event listeners al nuevo producto
            const nuevoTipo = nuevoProducto.querySelector('.producto-tipo');
            const nuevaCantidad = nuevoProducto.querySelector('.producto-cantidad');
            if (nuevoTipo) {
                nuevoTipo.addEventListener('change', () => {
                    actualizarPrecioAprox();
                    actualizarItemsAdicionales();
                });
            }
            if (nuevaCantidad) {
                nuevaCantidad.addEventListener('change', () => {
                    actualizarPrecioAprox();
                    actualizarItemsAdicionales();
                });
            }
        }

        function eliminarProducto(btn) {
            const productosList = document.getElementById('productosList');
            if (!productosList) return;
            
            if (productosList.querySelectorAll('.producto-item').length > 1) {
                btn.parentElement.remove();
                actualizarPrecioAprox();
            }
        }

        // Actualizar items adicionales automáticamente cuando se seleccionan semillas
        function actualizarItemsAdicionales() {
            const productosList = document.getElementById('productosList');
            const itemsAdicionalesList = document.getElementById('itemsAdicionalesList');
            if (!productosList || !itemsAdicionalesList) return;
            
            let totalSemillas = 0;
            productosList.querySelectorAll('.producto-item').forEach(item => {
                const tipo = item.querySelector('.producto-tipo')?.value;
                const cantidad = parseInt(item.querySelector('.producto-cantidad')?.value) || 0;
                if (tipo && tipo.startsWith('semilla_') && cantidad > 0) {
                    totalSemillas += cantidad;
                }
            });
            
            if (totalSemillas > 0) {
                let html = '<div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; border: 1px solid #86efac;">';
                html += '<p style="margin: 0 0 0.5rem 0; font-weight: 500;">Items adicionales (no modificables):</p>';
                html += `<p style="margin: 0; color: #6b7280;">1 Maceta: ${totalSemillas}</p>`;
                html += `<p style="margin: 0; color: #6b7280;">1 Regadera: ${totalSemillas}</p>`;
                html += `<p style="margin: 0; color: #6b7280;">1 Fertilizante: ${totalSemillas}</p>`;
                html += `<p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #059669;"><strong>Total: ${totalSemillas} de cada item</strong></p>`;
                html += '</div>';
                itemsAdicionalesList.innerHTML = html;
            } else {
                itemsAdicionalesList.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem;">Se agregarán automáticamente cuando selecciones semillas</p>';
            }
        }

        // Actualizar precio aproximado
        function actualizarPrecioAprox() {
            if (!esSargentoOAdmin()) return;
            
            const productos = [];
            const productosList = document.getElementById('productosList');
            if (!productosList) return;
            
            productosList.querySelectorAll('.producto-item').forEach(item => {
                const tipo = item.querySelector('.producto-tipo')?.value;
                const cantidad = parseInt(item.querySelector('.producto-cantidad')?.value) || 0;
                if (tipo && cantidad > 0) {
                    productos.push({ tipo, cantidad });
                }
            });
            
            const precioAprox = calcularPrecioAprox(productos);
            const precioAproxEl = document.getElementById('precioAprox');
            const precioAproxValor = document.getElementById('precioAproxValor');
            const notaBrotes = document.getElementById('notaBrotes');
            
            // Verificar si hay semillas en los productos
            const tieneSemillas = productos.some(p => p.tipo.startsWith('semilla_'));
            
            if (precioAproxEl && precioAproxValor) {
                if (precioAprox > 0) {
                    precioAproxEl.style.display = 'block';
                    precioAproxValor.textContent = precioAprox.toLocaleString();
                    // Mostrar nota sobre brotes si hay semillas
                    if (notaBrotes) {
                        notaBrotes.style.display = tieneSemillas ? 'block' : 'none';
                    }
                } else {
                    precioAproxEl.style.display = 'none';
                    if (notaBrotes) {
                        notaBrotes.style.display = 'none';
                    }
                }
            }
            
            // Actualizar items adicionales
            actualizarItemsAdicionales();
        }

        // Event listeners para actualizar precio e items adicionales
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('producto-tipo') || e.target.classList.contains('producto-cantidad')) {
                actualizarPrecioAprox();
                actualizarItemsAdicionales();
            }
        });

        // Manejar formulario de creación de entrega de productos
        const formCrearEntrega = document.getElementById('formCrearEntrega');
        if (formCrearEntrega) {
            formCrearEntrega.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!esSargentoOAdmin()) {
                    mostrarMensaje('Solo los sargentos y administradores pueden crear entregas de productos', 'error');
                    return;
                }
                
                const prospectId = document.getElementById('prospectSelectEntrega').value;
                if (!prospectId) {
                    mostrarMensaje('Selecciona un prospect', 'error');
                    return;
                }
                
                const productos = [];
                const productosList = document.getElementById('productosList');
                productosList.querySelectorAll('.producto-item').forEach(item => {
                    const tipo = item.querySelector('.producto-tipo').value;
                    const cantidad = parseInt(item.querySelector('.producto-cantidad').value) || 0;
                    if (tipo && cantidad > 0) {
                        productos.push({ tipo, cantidad });
                    }
                });
                
                if (productos.length === 0) {
                    mostrarMensaje('Agrega al menos un producto', 'error');
                    return;
                }
                
                // Items adicionales (fertilizante, maceta, regadera) - se agregan automáticamente para semillas
                const itemsAdicionales = [];
                productos.forEach(p => {
                    if (p.tipo.startsWith('semilla_')) {
                        itemsAdicionales.push({ tipo: 'fertilizante', cantidad: p.cantidad });
                        itemsAdicionales.push({ tipo: 'maceta', cantidad: p.cantidad });
                        itemsAdicionales.push({ tipo: 'regadera', cantidad: p.cantidad });
                    }
                });
                
                const notas = document.getElementById('notasEntrega').value;
                
                try {
                    mostrarMensaje('Creando entrega...', 'info', 'mensajeEntrega');
                    await crearEntregaProductos(currentUser.id, prospectId, productos, itemsAdicionales, notas);
                    mostrarMensaje('Entrega creada correctamente', 'success', 'mensajeEntrega');
                    formCrearEntrega.reset();
                    // Resetear lista de productos
                    productosList.innerHTML = `
                        <div class="producto-item">
                            <select class="producto-tipo" required>
                                <option value="">Seleccionar producto...</option>
                                <option value="coca">Coca</option>
                                <option value="meta">Meta</option>
                                <option value="crack">Crack</option>
                                <option value="weed">Weed</option>
                                <option value="semilla_maleza">Semilla Maleza</option>
                                <option value="semilla_amarillo">Semilla Amarillo</option>
                                <option value="semilla_azul">Semilla Azul</option>
                                <option value="semilla_morado">Semilla Morado</option>
                            </select>
                            <input type="number" class="producto-cantidad" min="1" value="1" required>
                            <button type="button" class="btn-remove" onclick="eliminarProducto(this)">Eliminar</button>
                        </div>
                    `;
                    actualizarPrecioAprox();
                    // Recargar listas
                    cargarListaEntregasPendientes();
                    cargarEntregasConfirmadasVendedor();
                } catch (error) {
                    console.error('Error creando entrega:', error);
                    mostrarMensaje(error.message, 'error', 'mensajeEntrega');
                }
            });
        }

        // Cargar entregas confirmadas para relacionar
        async function cargarEntregasConfirmadas() {
            if (!esDealer()) return;
            
            try {
                const entregas = await obtenerEntregasPorDealer(currentUser.id);
                entregasConfirmadas = entregas.filter(e => e.estado === 'confirmado');
                
                const listEl = document.getElementById('entregasRelacionadasList');
                if (entregasConfirmadas.length === 0) {
                    listEl.innerHTML = '<p style="color: #6b7280;">No hay entregas confirmadas</p>';
                    return;
                }
                
                let html = '';
                entregasConfirmadas.forEach(entrega => {
                    const fecha = entrega.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleDateString('es-PE') : '';
                    html += `
                        <label style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <input type="checkbox" value="${entrega.id}" class="entrega-checkbox">
                            <span style="margin-left: 0.5rem;">
                                ${entrega.vendedorNombre} - ${fechaStr} 
                                (${entrega.productos.map(p => `${obtenerNombreProducto(p.tipo)}: ${p.cantidad}`).join(', ')})
                            </span>
                        </label>
                    `;
                });
                listEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando entregas:', error);
            }
        }

        // Cargar tickets
        async function cargarTickets() {
            try {
                console.log('Cargando tickets para:', currentUser.id, 'Rol:', currentUser.rol);
                let tickets = [];
                let ticketsCreados = [];
                let ticketsRecibidos = [];
                
                if (esSargentoOAdmin()) {
                    // Sargentos ven tanto los que crearon como los que recibieron
                    ticketsCreados = await obtenerTicketsPorDealer(currentUser.id);
                    ticketsRecibidos = await obtenerTicketsPorVendedor(currentUser.id);
                    console.log('Tickets creados:', ticketsCreados.length, 'Tickets recibidos:', ticketsRecibidos.length);
                    
                    // Combinar sin duplicados
                    const ticketsIds = new Set();
                    ticketsCreados.forEach(t => {
                        ticketsIds.add(t.id);
                        tickets.push(t);
                    });
                    ticketsRecibidos.forEach(t => {
                        if (!ticketsIds.has(t.id)) {
                            tickets.push(t);
                        }
                    });
                    
                    document.getElementById('tituloTickets').textContent = 'Mis Tickets';
                } else {
                    tickets = await obtenerTicketsPorVendedor(currentUser.id);
                    console.log('Tickets recibidos como vendedor:', tickets.length);
                    document.getElementById('tituloTickets').textContent = 'Mis Tickets';
                }
                
                console.log('Total tickets a mostrar:', tickets.length);
                console.log('Estados de tickets:', tickets.map(t => ({ id: t.id, estado: t.estado, ticketId: t.ticketId })));
                mostrarTickets(tickets);
            } catch (error) {
                console.error('Error cargando tickets:', error);
            }
        }

        function mostrarTickets(tickets) {
            const listaEl = document.getElementById('listaTickets');
            
            if (!listaEl) {
                console.error('Elemento listaTickets no encontrado');
                return;
            }
            
            if (tickets.length === 0) {
                listaEl.innerHTML = '<p style="color: #6b7280;">No hay tickets</p>';
                return;
            }
            
            // Separar tickets pendientes, pendientes_dealer y confirmados
            const ticketsPendientes = tickets.filter(t => t.estado === 'pendiente');
            const ticketsPendientesDealer = tickets.filter(t => t.estado === 'pendiente_dealer');
            const ticketsConfirmados = tickets.filter(t => t.estado === 'confirmado');
            
            // Ordenar: primero pendientes, luego pendientes_dealer, luego confirmados
            const ticketsOrdenados = [...ticketsPendientes, ...ticketsPendientesDealer, ...ticketsConfirmados];
            
            // Determinar qué columnas mostrar
            const tieneTicketsCreados = tickets.some(t => t.dealerId === currentUser.id);
            const tieneTicketsRecibidos = tickets.some(t => t.vendedorId === currentUser.id);
            
            let html = '';
            
            // Mostrar alerta si hay tickets pendientes
            if (ticketsPendientes.length > 0) {
                html += `<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1rem; border-radius: 0.375rem;">
                    <strong>⚠️ Tienes ${ticketsPendientes.length} ticket(s) pendiente(s) de confirmar</strong>
                </div>`;
            }
            
            html += '<table class="data-table"><thead><tr>';
            if (tieneTicketsCreados && tieneTicketsRecibidos) {
                html += '<th>Tipo</th><th>Usuario</th><th>Ticket ID</th><th>Monto Aprox</th><th>Monto Entregado</th><th>Estado</th><th>Fecha</th><th>Acciones</th>';
            } else if (tieneTicketsCreados) {
                html += '<th>Vendedor</th><th>Ticket ID</th><th>Monto Aprox</th><th>Monto Entregado</th><th>Estado</th><th>Fecha</th><th>Acciones</th>';
            } else {
                html += '<th>Ticket ID</th><th>Dealer</th><th>Monto Entregado</th><th>Estado</th><th>Fecha</th><th>Acciones</th>';
            }
            html += '</tr></thead><tbody>';
            
            ticketsOrdenados.forEach(ticket => {
                const fecha = ticket.fechaCreacion?.toDate();
                const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                const estadoClass = ticket.estado === 'confirmado' ? 'success' : 
                                   ticket.estado === 'pendiente_dealer' ? 'warning' : 'pendiente';
                const esCreadoPorMi = ticket.dealerId === currentUser.id;
                const esRecibidoPorMi = ticket.vendedorId === currentUser.id;
                const esPendiente = ticket.estado === 'pendiente';
                
                // Resaltar filas pendientes
                const rowStyle = esPendiente ? 'background: #fef3c7; font-weight: 500;' : '';
                
                html += `<tr style="${rowStyle}">
                    ${tieneTicketsCreados && tieneTicketsRecibidos ? 
                        `<td>${esCreadoPorMi ? '<span style="color: #2563eb;">Creado</span>' : '<span style="color: #10b981;">Recibido</span>'}</td>
                         <td>${esCreadoPorMi ? ticket.vendedorNombre : ticket.dealerNombre}</td>` : 
                        (esCreadoPorMi ? `<td>${ticket.vendedorNombre}</td>` : `<td>${ticket.dealerNombre}</td>`)
                    }
                    <td><strong>${ticket.ticketId}</strong></td>
                    ${(tieneTicketsCreados || esCreadoPorMi) ? `<td>${ticket.montoAprox ? '$' + ticket.montoAprox.toLocaleString() : 'N/A'}</td>` : ''}
                    <td>${ticket.montoEntregado ? '$' + ticket.montoEntregado.toLocaleString() : '-'}</td>
                    <td><span class="estado-badge ${estadoClass}">${ticket.estado}</span></td>
                    <td>${fechaStr}</td>
                    <td>
                        ${ticket.estado === 'pendiente' && esRecibidoPorMi ? 
                            `<button class="btn-success btn-sm" onclick="confirmarTicketModal('${ticket.id}')">Confirmar</button>` : 
                            ''
                        }
                        ${esCreadoPorMi && ticket.estado === 'confirmado' && ticket.montoAprox ? 
                            `<span style="color: ${ticket.montoEntregado >= ticket.montoAprox ? '#10b981' : '#ef4444'};">
                                ${ticket.montoEntregado >= ticket.montoAprox ? '✓' : '⚠'} 
                                ${((ticket.montoEntregado / ticket.montoAprox) * 100).toFixed(1)}%
                            </span>` : 
                            ''
                        }
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            listaEl.innerHTML = html;
        }

        async function confirmarTicketModal(ticketId) {
            const monto = prompt('Ingresa el monto que entregaste:');
            if (!monto || isNaN(monto) || parseFloat(monto) <= 0) {
                alert('Monto inválido');
                return;
            }
            
            try {
                mostrarMensaje('Confirmando ticket...', 'info');
                await confirmarTicketDinero(ticketId, parseFloat(monto));
                mostrarMensaje('Ticket confirmado correctamente', 'success');
                cargarTickets();
            } catch (error) {
                mostrarMensaje(error.message, 'error');
            }
        }

        function mostrarMensaje(mensaje, tipo, elementoId = null) {
            let mensajeEl;
            if (elementoId) {
                mensajeEl = document.getElementById(elementoId);
            } else {
                mensajeEl = document.getElementById('mensajeTicket') || document.getElementById('mensajeEntrega');
            }
            if (!mensajeEl) {
                console.error('Elemento de mensaje no encontrado');
                alert(mensaje); // Fallback a alert si no encuentra el elemento
                return;
            }
            mensajeEl.textContent = mensaje;
            mensajeEl.className = `auth-message ${tipo}`;
            mensajeEl.style.display = 'block';
            setTimeout(() => {
                mensajeEl.style.display = 'none';
            }, 3000);
        }

        // El formulario de creación de tickets ya no existe - ahora se crean entregas de productos
        // Los tickets se crean automáticamente cuando un prospect entrega dinero

        // Actualizar navegación según rol
        function actualizarNavegacion() {
            const btnPanelAdmin = document.getElementById('btnPanelAdmin');
            const btnEntregas = document.getElementById('btnEntregas');
            const btnPerdidas = document.getElementById('btnPerdidas');
            
            if (esAdmin()) {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'inline-block';
            } else {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'none';
            }
            
            if (esSargentoOAdmin()) {
                if (btnEntregas) btnEntregas.style.display = 'inline-block';
                if (btnPerdidas) btnPerdidas.style.display = 'inline-block';
            } else {
                if (btnEntregas) btnEntregas.style.display = 'none';
                if (btnPerdidas) btnPerdidas.style.display = 'none';
            }
        }
        
        // dineroNegroTemp ya está declarado al inicio del script
        
        // Cargar lista de dinero negro para DEPOSITO
        function cargarDineroNegro() {
            console.log('=== cargarDineroNegro INICIADO ===');
            const listaEl = document.getElementById('listaDineroNegro');
            if (!listaEl) {
                console.error('Elemento listaDineroNegro no encontrado');
                return;
            }
            
            console.log('TIPOS_DINERO_NEGRO disponible?:', typeof TIPOS_DINERO_NEGRO !== 'undefined');
            if (typeof TIPOS_DINERO_NEGRO === 'undefined') {
                listaEl.innerHTML = '<p style="color: #ef4444;">Error: TIPOS_DINERO_NEGRO no está definido. Recarga la página.</p>';
                return;
            }
            
            console.log('TIPOS_DINERO_NEGRO:', TIPOS_DINERO_NEGRO);
            
            // Inicializar objeto temporal
            TIPOS_DINERO_NEGRO.forEach(tipo => {
                if (!dineroNegroTemp[tipo.id]) {
                    dineroNegroTemp[tipo.id] = 0;
                }
            });
            
            let html = '<table class="data-table"><thead><tr><th>Tipo de Dinero</th><th>Acción</th></tr></thead><tbody>';
            
            TIPOS_DINERO_NEGRO.forEach(tipo => {
                html += `<tr>
                    <td>${tipo.nombre}</td>
                    <td>
                        <button class="btn-primary btn-sm" onclick="registrarDepositoTipo('${tipo.id}')">Registrar</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            listaEl.innerHTML = html;
            console.log('✅ Lista de dinero negro cargada correctamente');
        }
        
        // Función para cargar sargentos en el selector
        async function cargarSargentosDeposito() {
            try {
                await ensureDb();
                // Cargar todos los usuarios y filtrar en el cliente para evitar necesidad de índices
                const snapshot = await db.collection('users')
                    .orderBy('nombre')
                    .get();
                
                const currentUser = getCurrentUser();
                const sargentos = snapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .filter(user => 
                        (user.rol === 'sargento' || user.rol === 'admin') && 
                        user.id !== currentUser.id // Excluir al usuario actual
                    );
                
                const select = document.getElementById('sargentoSelectDeposito');
                if (!select) return;
                
                select.innerHTML = '<option value="">Seleccionar sargento...</option>';
                
                if (sargentos.length === 0) {
                    select.innerHTML = '<option value="">No hay sargentos disponibles</option>';
                    return;
                }
                
                sargentos.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = `${s.nombre} ${s.apellido} (${s.username})`;
                    select.appendChild(option);
                });
                
                console.log('Sargentos cargados:', sargentos.length);
            } catch (error) {
                console.error('Error cargando sargentos:', error);
                const select = document.getElementById('sargentoSelectDeposito');
                if (select) {
                    select.innerHTML = '<option value="">Error cargando sargentos</option>';
                }
            }
        }
        
        // Función para registrar un depósito de un tipo específico
        async function registrarDepositoTipo(tipoId) {
            const sargentoSelect = document.getElementById('sargentoSelectDeposito');
            if (!sargentoSelect || !sargentoSelect.value) {
                alert('Por favor, selecciona un sargento primero');
                return;
            }
            
            const sargentoId = sargentoSelect.value;
            const tipo = TIPOS_DINERO_NEGRO.find(t => t.id === tipoId);
            
            const importe = prompt(`Ingresa el importe para ${tipo?.nombre}:`);
            if (!importe || isNaN(importe) || parseFloat(importe) <= 0) {
                alert('Importe inválido');
                return;
            }
            
            const mensajeEl = document.getElementById('mensajeDeposito');
            
            try {
                mensajeEl.textContent = 'Registrando depósito...';
                mensajeEl.className = 'auth-message info';
                mensajeEl.style.display = 'block';
                
                // Crear objeto con solo este tipo
                const importes = {};
                importes[tipoId] = parseFloat(importe);
                
                // Llamar a la función de crear depósito pero con el sargento seleccionado
                await crearDepositoDineroNegroConSargento(importes, sargentoId);
                
                mensajeEl.textContent = 'Depósito registrado correctamente. Quedará pendiente hasta que el sargento lo apruebe.';
                mensajeEl.className = 'auth-message success';
                mensajeEl.style.display = 'block';
                
                setTimeout(() => {
                    mensajeEl.style.display = 'none';
                }, 5000);
            } catch (error) {
                console.error('Error registrando depósito:', error);
                mensajeEl.textContent = 'Error: ' + error.message;
                mensajeEl.className = 'auth-message error';
                mensajeEl.style.display = 'block';
                alert('Error al registrar depósito: ' + error.message + '\n\nRevisa la consola para más detalles.');
                setTimeout(() => {
                    mensajeEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Función antigua para registrar el depósito (mantener por compatibilidad pero no se usa)
        async function registrarDeposito() {
            const mensajeEl = document.getElementById('mensajeDeposito');
            
            console.log('=== REGISTRAR DEPÓSITO INICIADO ===');
            console.log('dineroNegroTemp:', dineroNegroTemp);
            
            // Verificar que haya al menos un importe mayor a 0
            const tieneImportes = Object.values(dineroNegroTemp).some(importe => importe > 0);
            console.log('tieneImportes:', tieneImportes);
            
            if (!tieneImportes) {
                mensajeEl.textContent = 'Debes agregar al menos un importe para registrar el depósito';
                mensajeEl.className = 'auth-message error';
                mensajeEl.style.display = 'block';
                setTimeout(() => {
                    mensajeEl.style.display = 'none';
                }, 3000);
                return;
            }
            
            try {
                console.log('Verificando que productos.js esté cargado...');
                if (typeof TIPOS_DINERO_NEGRO === 'undefined') {
                    throw new Error('TIPOS_DINERO_NEGRO no está definido. Asegúrate de que productos.js esté cargado.');
                }
                console.log('TIPOS_DINERO_NEGRO:', TIPOS_DINERO_NEGRO);
                
                mensajeEl.textContent = 'Registrando depósito...';
                mensajeEl.className = 'auth-message info';
                mensajeEl.style.display = 'block';
                
                console.log('Llamando a crearDepositoDineroNegro...');
                const depositoId = await crearDepositoDineroNegro(dineroNegroTemp);
                console.log('Depósito creado con ID:', depositoId);
                
                mensajeEl.textContent = 'Depósito registrado correctamente. Quedará pendiente hasta que un sargento lo apruebe.';
                mensajeEl.className = 'auth-message success';
                mensajeEl.style.display = 'block';
                
                // Limpiar los importes
                if (typeof TIPOS_DINERO_NEGRO !== 'undefined') {
                    TIPOS_DINERO_NEGRO.forEach(tipo => {
                        dineroNegroTemp[tipo.id] = 0;
                    });
                } else {
                    // Fallback: limpiar todas las claves
                    Object.keys(dineroNegroTemp).forEach(key => {
                        dineroNegroTemp[key] = 0;
                    });
                }
                cargarDineroNegro();
                
                setTimeout(() => {
                    mensajeEl.style.display = 'none';
                }, 5000);
            } catch (error) {
                console.error('❌ Error registrando depósito:', error);
                console.error('Stack trace:', error.stack);
                mensajeEl.textContent = 'Error: ' + error.message;
                mensajeEl.className = 'auth-message error';
                mensajeEl.style.display = 'block';
                alert('Error al registrar depósito: ' + error.message + '\n\nRevisa la consola para más detalles.');
                setTimeout(() => {
                    mensajeEl.style.display = 'none';
                }, 5000);
            }
        }

        // Función para cargar depósitos pendientes del prospect
        async function cargarDepositosPendientesProspect() {
            if (!esProspect()) return;
            
            try {
                const depositos = await obtenerDepositosPendientesProspect(currentUser.id);
                const listaEl = document.getElementById('listaDepositosPendientesProspect');
                
                if (!listaEl) {
                    console.error('Elemento listaDepositosPendientesProspect no encontrado');
                    return;
                }
                
                if (depositos.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No tienes depósitos pendientes</p>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 1rem;">';
                
                depositos.forEach(deposito => {
                    const fechaCreacion = deposito.fechaCreacion?.toDate();
                    const fechaCreacionStr = fechaCreacion ? fechaCreacion.toLocaleString('es-PE') : 'N/A';
                    
                    html += `<div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: #fef3c7;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">`;
                    html += `<div>`;
                    html += `<h3 style="margin: 0 0 0.5rem 0;">Depósito para ${deposito.sargentoNombre}</h3>`;
                    html += `<p style="color: #6b7280; margin: 0; font-size: 0.875rem;">Fecha: ${fechaCreacionStr}</p>`;
                    html += `<p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.875rem;">Monto Total: <strong>$${deposito.montoTotal.toLocaleString()}</strong></p>`;
                    html += `</div>`;
                    html += `<span class="estado-badge pendiente">Pendiente</span>`;
                    html += `</div>`;
                    
                    html += `<div style="margin-top: 1rem;">`;
                    html += `<h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #374151;">Detalles del Depósito:</h4>`;
                    html += `<div style="background: white; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db;">`;
                    html += `<ul style="margin: 0; padding-left: 1.5rem;">`;
                    deposito.detalles.forEach(detalle => {
                        html += `<li style="margin-bottom: 0.25rem;">${detalle.tipoNombre}: <strong>$${detalle.monto.toLocaleString()}</strong></li>`;
                    });
                    html += `</ul>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                
                html += '</div>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando depósitos pendientes del prospect:', error);
                const listaEl = document.getElementById('listaDepositosPendientesProspect');
                if (listaEl) {
                    listaEl.innerHTML = '<p style="color: #ef4444;">Error cargando depósitos: ' + error.message + '</p>';
                }
            }
        }

        // Inicializar
        actualizarNavegacion();
        
        if (!entregaId) {
            cargarTickets();
        }
    </script>
</body>
</html>

