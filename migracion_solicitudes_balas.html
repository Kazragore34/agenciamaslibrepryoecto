<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migraci√≥n de Solicitudes de Balas</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f9fafb;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .info {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.375rem;
        }
        button {
            background: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin-right: 1rem;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log {
            background: #1f2937;
            color: #10b981;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success {
            color: #10b981;
            font-weight: 600;
            margin-top: 1rem;
        }
        .error {
            color: #ef4444;
            font-weight: 600;
            margin-top: 1rem;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1>üîß Migraci√≥n de Solicitudes de Balas</h1>
        
        <div class="info">
            <strong>¬øQu√© hace este script?</strong><br>
            Este script corrige el campo <code>solicitudesBalas</code> en todas las armas de la base de datos.
            Agrega el campo si falta, lo convierte a array si es necesario, y corrige el formato de las solicitudes existentes.
        </div>

        <button id="btnMigrar" onclick="ejecutarMigracion()">Ejecutar Migraci√≥n</button>
        <button onclick="location.href='menu.html'">Volver al Men√∫</button>

        <div id="resultado"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script src="firebase-config.js"></script>
    <script>
        // Redirigir logs a la p√°gina
        const logDiv = document.getElementById('log');
        const originalLog = console.log;
        const originalError = console.error;
        
        function addLog(message, type = 'log') {
            if (logDiv) {
                logDiv.style.display = 'block';
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'error' ? '#ef4444' : '#10b981';
                logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        // Funci√≥n para esperar a que db est√© disponible
        async function ensureDb() {
            let attempts = 0;
            while (typeof db === 'undefined' && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            if (typeof db === 'undefined') {
                throw new Error('Firebase no est√° inicializado. Por favor, recarga la p√°gina.');
            }
            return db;
        }

        async function ejecutarMigracion() {
            // Asegurar que db est√© disponible
            await ensureDb();
            const btn = document.getElementById('btnMigrar');
            const resultado = document.getElementById('resultado');
            
            btn.disabled = true;
            btn.textContent = 'Ejecutando...';
            resultado.innerHTML = '';
            logDiv.innerHTML = '';
            logDiv.style.display = 'block';

            try {
                console.log('=== INICIANDO MIGRACI√ìN DE SOLICITUDES DE BALAS ===');
                
                // Asegurar que db est√© disponible
                if (typeof db === 'undefined') {
                    throw new Error('Firebase no est√° inicializado. Por favor, recarga la p√°gina.');
                }
                
                // Obtener todas las armas
                const snapshot = await db.collection('entregas_armas').get();
                console.log(`Total de armas encontradas: ${snapshot.size}`);
                
                let armasActualizadas = 0;
                let solicitudesCorregidas = 0;
                
                let batch = db.batch();
                let batchCount = 0;
                const BATCH_SIZE = 500;
                
                // Usar for...of en lugar de forEach para poder usar await
                const docs = snapshot.docs;
                for (let i = 0; i < docs.length; i++) {
                    const doc = docs[i];
                    const armaData = doc.data();
                    let necesitaActualizacion = false;
                    const actualizaciones = {};
                    
                    // Verificar si falta el campo solicitudesBalas
                    if (!armaData.hasOwnProperty('solicitudesBalas')) {
                        console.log(`Arma ${doc.id}: Falta campo solicitudesBalas, agregando...`);
                        actualizaciones.solicitudesBalas = [];
                        necesitaActualizacion = true;
                    }
                    // Verificar si el campo no es un array
                    else if (!Array.isArray(armaData.solicitudesBalas)) {
                        console.log(`Arma ${doc.id}: Campo solicitudesBalas no es un array, corrigiendo...`);
                        actualizaciones.solicitudesBalas = [];
                        necesitaActualizacion = true;
                    }
                    // Verificar y corregir solicitudes que no tengan el formato correcto
                    else if (Array.isArray(armaData.solicitudesBalas) && armaData.solicitudesBalas.length > 0) {
                        let tieneProblemas = false;
                        const solicitudesCorregidasArray = armaData.solicitudesBalas.map(solicitud => {
                            // Si la solicitud no tiene estado, agregarlo como 'pendiente'
                            if (!solicitud.hasOwnProperty('estado')) {
                                console.log(`Arma ${doc.id}: Solicitud sin estado, agregando estado 'pendiente'`);
                                tieneProblemas = true;
                                return {
                                    ...solicitud,
                                    estado: 'pendiente'
                                };
                            }
                            // Si el estado no es string, convertirlo
                            if (typeof solicitud.estado !== 'string') {
                                console.log(`Arma ${doc.id}: Estado no es string, corrigiendo...`);
                                tieneProblemas = true;
                                return {
                                    ...solicitud,
                                    estado: String(solicitud.estado) === 'pendiente' ? 'pendiente' : 'entregada'
                                };
                            }
                            return solicitud;
                        });
                        
                        if (tieneProblemas) {
                            actualizaciones.solicitudesBalas = solicitudesCorregidasArray;
                            necesitaActualizacion = true;
                            solicitudesCorregidas += solicitudesCorregidasArray.length;
                        }
                    }
                    
                    if (necesitaActualizacion) {
                        batch.update(doc.ref, actualizaciones);
                        batchCount++;
                        armasActualizadas++;
                        
                        // Si el batch est√° lleno, hacer commit y crear uno nuevo
                        if (batchCount >= BATCH_SIZE) {
                            await batch.commit();
                            console.log(`Batch de ${batchCount} actualizaciones guardado`);
                            batch = db.batch(); // Crear nuevo batch
                            batchCount = 0;
                        }
                    }
                }
                
                // Hacer commit del batch final si hay actualizaciones pendientes
                if (batchCount > 0) {
                    await batch.commit();
                    console.log(`Batch final de ${batchCount} actualizaciones guardado`);
                }
                
                console.log('=== MIGRACI√ìN COMPLETADA ===');
                console.log(`Armas actualizadas: ${armasActualizadas}`);
                console.log(`Solicitudes corregidas: ${solicitudesCorregidas}`);
                
                resultado.innerHTML = `
                    <div class="success">
                        ‚úÖ <strong>Migraci√≥n completada exitosamente</strong><br>
                        Total de armas: ${snapshot.size}<br>
                        Armas actualizadas: ${armasActualizadas}<br>
                        Solicitudes corregidas: ${solicitudesCorregidas}
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Error en la migraci√≥n:', error);
                resultado.innerHTML = `
                    <div class="error">
                        ‚ùå <strong>Error en la migraci√≥n:</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ejecutar Migraci√≥n';
            }
        }
    </script>
</body>
</html>

