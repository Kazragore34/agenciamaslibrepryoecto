<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculador de Precios - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-fichaje.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="calculador-container">
        <div class="fichaje-header">
            <h1>Calculador de Precios</h1>
            <div>
                <a href="fichaje.html" class="btn-primary" style="text-decoration: none; padding: 0.5rem 1rem; margin-right: 0.5rem;">Fichaje</a>
                <a href="horas.html" class="btn-primary" style="text-decoration: none; padding: 0.5rem 1rem; margin-right: 0.5rem;">Horas</a>
                <a href="estadisticas.html" class="btn-primary" style="text-decoration: none; padding: 0.5rem 1rem; margin-right: 0.5rem;">Estadísticas</a>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <div class="calculador-grid">
            <div class="calculador-section">
                <h3>Configuración del Tuneo</h3>
                
                <div class="form-group">
                    <label for="categoria">Categoría del Vehículo</label>
                    <select id="categoria" class="form-group select" onchange="calcular()">
                        <option value="">Selecciona una categoría</option>
                        <option value="compacts">Compacts</option>
                        <option value="coupes">Coupes</option>
                        <option value="motos taller regular">Motos Taller Regular</option>
                        <option value="muscle">Muscle</option>
                        <option value="off road">Off Road</option>
                        <option value="sedans">Sedans</option>
                        <option value="sports">Sports</option>
                        <option value="sports classics">Sports Classics</option>
                        <option value="super">Super</option>
                        <option value="suv's">SUV's</option>
                        <option value="motos taller de motor">Motos Taller de Motor</option>
                        <option value="vans">Vans</option>
                        <option value="importación (sangre)">Importación (Sangre)</option>
                    </select>
                </div>

                <div class="form-group">
                    <h4 style="margin-bottom: 1rem;">Servicios</h4>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="fullTuning" onchange="calcular()">
                            <span>Full Tuning</span>
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="motor" onchange="calcular()">
                            <span>Motor</span>
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="frenos" onchange="calcular()">
                            <span>Frenos</span>
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="transmision" onchange="calcular()">
                            <span>Transmisión</span>
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="turbo" onchange="calcular()">
                            <span>Turbo</span>
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="suspension" onchange="calcular()">
                            <span>Suspensión</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="cantidadPiezas">Cantidad de Piezas</label>
                    <input type="number" id="cantidadPiezas" class="input-number" min="0" value="0" onchange="calcular()" oninput="calcular()">
                </div>

                <div class="descuento-section">
                    <h4 style="margin-bottom: 1rem;">Descuentos</h4>
                    
                    <div class="form-group">
                        <label for="tipoDescuento">Tipo de Descuento</label>
                        <select id="tipoDescuento" class="form-group select" onchange="mostrarCamposDescuento()">
                            <option value="">Sin descuento</option>
                            <option value="convenio">Convenio (20%)</option>
                            <option value="amistad">Amistad (5-10%)</option>
                        </select>
                    </div>

                    <div id="convenioGroup" class="persona-entidad-group">
                        <div class="form-group">
                            <label for="entidadConvenio">Entidad</label>
                            <select id="entidadConvenio" class="form-group select" onchange="calcular()">
                                <option value="">Selecciona una entidad</option>
                                <option value="Mecánicos">Mecánicos</option>
                                <option value="Motor Club">Motor Club</option>
                                <option value="Puf Puf">Puf Puf</option>
                                <option value="Médicos">Médicos</option>
                            </select>
                        </div>
                    </div>

                    <div id="amistadGroup" class="persona-entidad-group">
                        <div class="form-group">
                            <label for="porcentajeAmistad">Porcentaje de Descuento</label>
                            <input type="range" id="porcentajeAmistad" class="slider" min="5" max="10" value="5" step="1" onchange="actualizarSlider()" oninput="actualizarSlider()">
                            <div class="slider-value" id="sliderValue">5%</div>
                        </div>
                        <div class="form-group">
                            <label for="personaAmistad">Nombre de la Persona</label>
                            <input type="text" id="personaAmistad" class="input-number" placeholder="Nombre del cliente">
                        </div>
                    </div>
                </div>
            </div>

            <div class="calculador-section">
                <h3>Resumen</h3>
                <div id="resumenPrecios" style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <p style="color: #6b7280; text-align: center;">Selecciona una categoría y servicios</p>
                </div>

                <div class="precio-total">
                    <h3>Precio Total</h3>
                    <div class="precio" id="precioTotal">$0</div>
                </div>

                <button class="btn-primary" onclick="guardarTuneo()" style="width: 100%; margin-top: 2rem; padding: 1rem; font-size: 1.1rem;">
                    Registrar Tuneo
                </button>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="crypto-utils.js"></script>
    <script src="auth.js"></script>
    <script src="calculador.js"></script>
    <script>
        requireAuth();

        function mostrarCamposDescuento() {
            const tipoDescuento = document.getElementById('tipoDescuento').value;
            const convenioGroup = document.getElementById('convenioGroup');
            const amistadGroup = document.getElementById('amistadGroup');

            convenioGroup.classList.remove('visible');
            amistadGroup.classList.remove('visible');

            if (tipoDescuento === 'convenio') {
                convenioGroup.classList.add('visible');
            } else if (tipoDescuento === 'amistad') {
                amistadGroup.classList.add('visible');
            }

            calcular();
        }

        function actualizarSlider() {
            const slider = document.getElementById('porcentajeAmistad');
            const value = slider.value;
            document.getElementById('sliderValue').textContent = `${value}%`;
            calcular();
        }

        function calcular() {
            const categoria = document.getElementById('categoria').value;
            if (!categoria) {
                document.getElementById('resumenPrecios').innerHTML = '<p style="color: #6b7280; text-align: center;">Selecciona una categoría y servicios</p>';
                document.getElementById('precioTotal').textContent = '$0';
                return;
            }

            const servicios = {
                fullTuning: document.getElementById('fullTuning').checked,
                motor: document.getElementById('motor').checked,
                frenos: document.getElementById('frenos').checked,
                transmision: document.getElementById('transmision').checked,
                turbo: document.getElementById('turbo').checked,
                suspension: document.getElementById('suspension').checked
            };

            const cantidadPiezas = parseInt(document.getElementById('cantidadPiezas').value) || 0;
            const tipoDescuento = document.getElementById('tipoDescuento').value;
            
            let porcentajeDescuento = 0;
            if (tipoDescuento === 'convenio') {
                porcentajeDescuento = 20;
            } else if (tipoDescuento === 'amistad') {
                porcentajeDescuento = parseInt(document.getElementById('porcentajeAmistad').value);
            }

            const resultado = calcularPrecio(categoria, servicios, cantidadPiezas, tipoDescuento, porcentajeDescuento);

            // Mostrar resumen
            let resumenHTML = `
                <div style="margin-bottom: 0.5rem;"><strong>Precio Base:</strong> ${formatPrecio(resultado.precioBase)}</div>
            `;

            if (resultado.descuento > 0) {
                resumenHTML += `
                    <div style="margin-bottom: 0.5rem; color: #059669;"><strong>Descuento (${porcentajeDescuento}%):</strong> -${formatPrecio(resultado.descuento)}</div>
                `;
            }

            document.getElementById('resumenPrecios').innerHTML = resumenHTML;
            document.getElementById('precioTotal').textContent = formatPrecio(resultado.precioTotal);
        }

        async function guardarTuneo() {
            try {
                const user = getCurrentUser();
                if (!user) {
                    alert('Debes estar autenticado para registrar un tuneo');
                    return;
                }

                const categoria = document.getElementById('categoria').value;
                if (!categoria) {
                    alert('Selecciona una categoría');
                    return;
                }

                const servicios = {
                    fullTuning: document.getElementById('fullTuning').checked,
                    motor: document.getElementById('motor').checked,
                    frenos: document.getElementById('frenos').checked,
                    transmision: document.getElementById('transmision').checked,
                    turbo: document.getElementById('turbo').checked,
                    suspension: document.getElementById('suspension').checked
                };

                const cantidadPiezas = parseInt(document.getElementById('cantidadPiezas').value) || 0;
                const tipoDescuento = document.getElementById('tipoDescuento').value;
                
                let porcentajeDescuento = 0;
                let personaEntidad = null;

                if (tipoDescuento === 'convenio') {
                    porcentajeDescuento = 20;
                    personaEntidad = document.getElementById('entidadConvenio').value;
                    if (!personaEntidad) {
                        alert('Selecciona una entidad para el descuento por convenio');
                        return;
                    }
                } else if (tipoDescuento === 'amistad') {
                    porcentajeDescuento = parseInt(document.getElementById('porcentajeAmistad').value);
                    personaEntidad = document.getElementById('personaAmistad').value;
                    if (!personaEntidad) {
                        alert('Ingresa el nombre de la persona para el descuento de amistad');
                        return;
                    }
                }

                const resultado = calcularPrecio(categoria, servicios, cantidadPiezas, tipoDescuento, porcentajeDescuento);

                const detalles = {
                    servicios: servicios,
                    cantidadPiezas: cantidadPiezas,
                    precioBase: resultado.precioBase
                };

                const tuneoId = await registrarTuneo(user.id, resultado.precioTotal, categoria, personaEntidad, tipoDescuento || null, porcentajeDescuento || null, detalles);

                alert('Tuneo registrado correctamente');
                
                // Limpiar formulario
                document.getElementById('categoria').value = '';
                document.getElementById('fullTuning').checked = false;
                document.getElementById('motor').checked = false;
                document.getElementById('frenos').checked = false;
                document.getElementById('transmision').checked = false;
                document.getElementById('turbo').checked = false;
                document.getElementById('suspension').checked = false;
                document.getElementById('cantidadPiezas').value = '0';
                document.getElementById('tipoDescuento').value = '';
                document.getElementById('entidadConvenio').value = '';
                document.getElementById('personaAmistad').value = '';
                mostrarCamposDescuento();
                calcular();
            } catch (error) {
                console.error('Error registrando tuneo:', error);
                alert('Error al registrar el tuneo: ' + error.message);
            }
        }

        // Inicializar
        mostrarCamposDescuento();
    </script>
</body>
</html>

