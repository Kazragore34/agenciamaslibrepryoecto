// Reglas de seguridad de Firestore
// Copia estas reglas en Firebase Console > Firestore Database > Rules
//
// IMPORTANTE: Este sistema usa autenticación manual (localStorage), por lo que
// las reglas de Firestore no pueden verificar roles directamente.
// Estas reglas están configuradas para permitir el funcionamiento básico.
// Para mayor seguridad, considera implementar Firebase Authentication o Cloud Functions.

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function para verificar autenticación
    // Nota: Con autenticación manual, esto siempre será false
    // Por eso las reglas están más permisivas
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Colección de usuarios
    match /users/{userId} {
      // Permitir lectura para búsquedas de username
      allow read: if true;
      // Permitir creación (registro)
      allow create: if true;
      // Permitir actualización (la validación se hace en el código)
      allow update: if true;
    }
    
    // Colección de entregas de productos
    match /entregas_productos/{entregaId} {
      // Permitir lectura a todos (la validación se hace en el código)
      allow read: if true;
      // Permitir creación (la validación de rol se hace en el código)
      allow create: if true;
      // Permitir actualización (la validación se hace en el código)
      allow update: if true;
      // Permitir eliminación (la validación se hace en el código)
      allow delete: if true;
    }
    
    // Colección de tickets de dinero
    match /tickets_dinero/{ticketId} {
      // Permitir lectura a todos
      allow read: if true;
      // Permitir creación (la validación de rol se hace en el código)
      allow create: if true;
      // Permitir actualización (la validación se hace en el código)
      allow update: if true;
    }
    
    // Colección de entregas de armas
    match /entregas_armas/{armaId} {
      // Permitir lectura a todos
      allow read: if true;
      // Permitir creación (la validación de rol se hace en el código)
      allow create: if true;
      // Permitir actualización (la validación se hace en el código)
      allow update: if true;
    }
    
    // Colección de metas
    match /metas/{metaId} {
      // Permitir lectura a todos
      allow read: if true;
      // Permitir creación y actualización (se hace desde las funciones)
      allow create, update: if true;
    }
    
    // Colección de depósitos de dinero negro
    match /depositos_dinero_negro/{depositoId} {
      // Permitir lectura a todos (la validación de rol sargento/admin se hace en el código)
      allow read: if true;
      // Permitir creación (la validación de rol prospect/sargento se hace en el código)
      allow create: if true;
      // Permitir actualización (la validación de rol sargento/admin se hace en el código)
      allow update: if true;
    }
    
    // Colección de solicitudes de chalecos independientes
    match /solicitudes_chalecos/{solicitudId} {
      // Permitir lectura a todos (la validación de rol sargento/admin se hace en el código)
      allow read: if true;
      // Permitir creación (la validación de rol prospect se hace en el código)
      allow create: if true;
      // Permitir actualización (la validación de rol sargento/admin se hace en el código)
      allow update: if true;
    }
  }
}

// ============================================
// VERSIÓN ALTERNATIVA (Si implementas Firebase Auth)
// ============================================
// Descomenta esta sección y comenta la anterior si implementas Firebase Authentication
//
// rules_version = '2';
// service cloud.firestore {
//   match /databases/{database}/documents {
//     
//     function isAuthenticated() {
//       return request.auth != null;
//     }
//     
//     function getUserRole() {
//       return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol;
//     }
//     
//     function isDealer() {
//       return isAuthenticated() && getUserRole() == 'dealer';
//     }
//     
//     function isVendedor() {
//       return isAuthenticated() && getUserRole() == 'vendedor';
//     }
//     
//     match /users/{userId} {
//       allow read: if true;
//       allow create: if true;
//       allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['nombre', 'apellido']) ||
//                     isDealer();
//     }
//     
//     match /entregas_productos/{entregaId} {
//       allow read: if isAuthenticated();
//       allow create: if isDealer();
//       allow update: if (resource.data.dealerId == request.auth.uid && resource.data.estado == 'pendiente') ||
//                      (resource.data.vendedorId == request.auth.uid && resource.data.estado == 'pendiente');
//       allow delete: if resource.data.dealerId == request.auth.uid && resource.data.estado == 'pendiente';
//     }
//     
//     match /tickets_dinero/{ticketId} {
//       allow read: if isAuthenticated();
//       allow create: if isDealer();
//       allow update: if resource.data.vendedorId == request.auth.uid && resource.data.estado == 'pendiente';
//     }
//     
//     match /entregas_armas/{armaId} {
//       allow read: if isAuthenticated();
//       allow create: if isDealer();
//       allow update: if resource.data.dealerId == request.auth.uid ||
//                      (resource.data.vendedorId == request.auth.uid && resource.data.estado == 'activa');
//     }
//     
//     match /metas/{metaId} {
//       allow read: if isAuthenticated();
//       allow create, update: if isAuthenticated();
//     }
//   }
// }
