<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horas Trabajadas - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-fichaje.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="stats-container">
        <div class="fichaje-header">
            <h1>Horas Trabajadas</h1>
            <div>
                <a href="fichaje.html" class="btn-primary">Fichaje</a>
                <a href="horas.html" class="btn-primary">Horas</a>
                <a href="calculador.html" class="btn-primary">Calculador</a>
                <a href="estadisticas.html" class="btn-primary">Estadísticas</a>
                <a id="btnPanelAdmin" href="admin.html" class="btn-primary">Admin</a>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <div class="stats-card" style="margin-top: 2rem;">
            <h3>Filtros</h3>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>Usuario (solo jefes/encargados)</label>
                    <select id="userFilter" class="form-group select">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>Semana</label>
                    <input type="week" id="weekFilter" class="input-number">
                </div>
            </div>
        </div>

        <div class="stats-card">
            <h3>Resumen de Horas por Semana</h3>
            <div id="horasTable"></div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="crypto-utils.js"></script>
    <script src="auth.js"></script>
    <script src="admin.js"></script>
    <script src="fichaje.js"></script>
    <script>
        requireAuth();
        
        const currentUser = getCurrentUser();
        const userFilter = document.getElementById('userFilter');
        const weekFilter = document.getElementById('weekFilter');
        
        // Configurar semana actual por defecto
        const hoy = new Date();
        const semanaActual = getWeekStart(hoy);
        const year = semanaActual.getFullYear();
        const week = getWeekNumber(semanaActual);
        weekFilter.value = `${year}-W${week.toString().padStart(2, '0')}`;

        // Cargar usuarios si es jefe o encargado
        if (currentUser && (currentUser.rol === 'jefe' || currentUser.rol === 'encargado')) {
            cargarUsuarios();
        } else {
            userFilter.style.display = 'none';
            userFilter.parentElement.style.display = 'none';
        }

        // Event listeners
        userFilter.addEventListener('change', cargarHoras);
        weekFilter.addEventListener('change', cargarHoras);

        async function cargarUsuarios() {
            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.orderBy('nombre').get();
                
                snapshot.docs.forEach(doc => {
                    const user = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${user.nombre} ${user.apellido} (${user.username})`;
                    userFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando usuarios:', error);
            }
        }

        async function cargarHoras() {
            try {
                const userId = userFilter.value || currentUser.id;
                const weekValue = weekFilter.value;
                
                if (!weekValue) {
                    document.getElementById('horasTable').innerHTML = '<p>Selecciona una semana</p>';
                    return;
                }

                // Parsear semana
                const [year, week] = weekValue.split('-W').map(Number);
                const semanaInicio = getDateFromWeek(year, week);
                const semanaFin = getWeekEnd(semanaInicio);
                
                const semanaInicioTimestamp = firebase.firestore.Timestamp.fromDate(semanaInicio);
                
                // Si se seleccionó "Todos", mostrar vista resumida
                if (!userFilter.value && (currentUser.rol === 'jefe' || currentUser.rol === 'encargado')) {
                    await mostrarResumenTodos(semanaInicio, semanaFin, semanaInicioTimestamp);
                    return;
                }
                
                // Buscar resumen de semana para un usuario específico
                const semanaRef = db.collection('semanas').doc(`${userId}_${semanaInicioTimestamp.toMillis()}`);
                const semanaDoc = await semanaRef.get();
                
                let horasTotales = 0;
                if (semanaDoc.exists) {
                    horasTotales = semanaDoc.data().horasTotales || 0;
                }

                // También buscar fichajes individuales de esa semana
                const fichajesRef = db.collection('fichajes');
                // Obtener todos los fichajes del usuario y filtrar por semana en memoria
                const snapshot = await fichajesRef
                    .where('userId', '==', userId)
                    .get();
                
                // Filtrar por semana en memoria
                const fichajesRaw = snapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .filter(fichaje => {
                        if (!fichaje.semanaInicio) return false;
                        const fichajeSemanaInicio = fichaje.semanaInicio.toDate ? fichaje.semanaInicio.toDate() : new Date(fichaje.semanaInicio);
                        return fichajeSemanaInicio.getTime() === semanaInicio.getTime();
                    });
                
                // Ordenar en memoria
                fichajesRaw.sort((a, b) => {
                    const fechaA = a.entrada && a.entrada.toDate ? a.entrada.toDate() : new Date(0);
                    const fechaB = b.entrada && b.entrada.toDate ? b.entrada.toDate() : new Date(0);
                    return fechaB - fechaA;
                });
                
                const fichajes = fichajesRaw;

                mostrarHoras(horasTotales, fichajes, semanaInicio, semanaFin);
            } catch (error) {
                console.error('Error cargando horas:', error);
                document.getElementById('horasTable').innerHTML = '<p style="color: #dc2626;">Error al cargar las horas</p>';
            }
        }

        async function mostrarResumenTodos(semanaInicio, semanaFin, semanaInicioTimestamp) {
            try {
                // Obtener todos los usuarios
                const usersRef = db.collection('users');
                const usersSnapshot = await usersRef.get();
                
                // Obtener todas las semanas de esa fecha
                const semanasRef = db.collection('semanas');
                const semanasSnapshot = await semanasRef.get();
                
                const resumen = [];
                
                usersSnapshot.docs.forEach(userDoc => {
                    const user = userDoc.data();
                    const userId = userDoc.id;
                    
                    // Buscar semana de este usuario
                    const semanaDoc = semanasSnapshot.docs.find(doc => {
                        const data = doc.data();
                        return data.userId === userId && 
                               data.semanaInicio && 
                               data.semanaInicio.toMillis() === semanaInicioTimestamp.toMillis();
                    });
                    
                    let horasTotales = 0;
                    if (semanaDoc && semanaDoc.exists) {
                        horasTotales = semanaDoc.data().horasTotales || 0;
                    }
                    
                    resumen.push({
                        nombre: `${user.nombre} ${user.apellido}`,
                        username: user.username,
                        horas: horasTotales
                    });
                });
                
                // Ordenar por nombre
                resumen.sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                // Mostrar tabla resumida
                const tableContainer = document.getElementById('horasTable');
                let html = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                        <strong>Semana:</strong> ${formatDate(semanaInicio)} - ${formatDate(semanaFin)}<br>
                        <strong>Vista:</strong> Resumen de todos los usuarios
                    </div>
                `;
                
                if (resumen.length === 0) {
                    html += '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos para esta semana</p>';
                } else {
                    html += `
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Semana</th>
                                    <th>Horas</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    resumen.forEach(item => {
                        html += `
                            <tr>
                                <td>
                                    <strong>${item.nombre}</strong><br>
                                    <small style="color: #6b7280;">${item.username}</small>
                                </td>
                                <td>${formatDate(semanaInicio)} - ${formatDate(semanaFin)}</td>
                                <td><strong>${formatHoras(item.horas)}</strong></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                tableContainer.innerHTML = html;
            } catch (error) {
                console.error('Error mostrando resumen:', error);
                document.getElementById('horasTable').innerHTML = '<p style="color: #dc2626;">Error al cargar el resumen</p>';
            }
        }

        function mostrarHoras(horasTotales, fichajes, semanaInicio, semanaFin) {
            const tableContainer = document.getElementById('horasTable');
            
            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                    <strong>Semana:</strong> ${formatDate(semanaInicio)} - ${formatDate(semanaFin)}<br>
                    <strong>Total de horas:</strong> ${formatHoras(horasTotales)}
                </div>
            `;

            if (fichajes.length === 0) {
                html += '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay fichajes registrados en esta semana</p>';
            } else {
                html += `
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Entrada</th>
                                <th>Salida</th>
                                <th>Horas</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                fichajes.forEach(fichaje => {
                    const entrada = formatDate(fichaje.entrada);
                    const salida = fichaje.salida ? formatDate(fichaje.salida) : 'En curso';
                    
                    let horas = '-';
                    if (fichaje.completado && fichaje.horasSemanaActual !== undefined) {
                        const horasTotales = (fichaje.horasSemanaActual || 0) + (fichaje.horasSemanaSiguiente || 0);
                        horas = formatHoras(horasTotales);
                    } else if (fichaje.entrada) {
                        // Calcular horas en tiempo real para fichajes en curso
                        let entradaDate = fichaje.entrada;
                        if (entradaDate && entradaDate.toDate) {
                            entradaDate = entradaDate.toDate();
                        } else {
                            entradaDate = new Date(entradaDate);
                        }
                        const ahora = new Date();
                        const diferencia = (ahora - entradaDate) / (1000 * 60 * 60);
                        horas = formatHoras(Math.max(0, diferencia));
                    }
                    
                    html += `
                        <tr>
                            <td>${entrada}</td>
                            <td>${salida}</td>
                            <td><strong>${horas}</strong></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
            }

            tableContainer.innerHTML = html;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getDateFromWeek(year, week) {
            const simple = new Date(year, 0, 1 + (week - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4) {
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            } else {
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            }
            return ISOweekStart;
        }

        // Mostrar/ocultar botón Panel Admin según el rol del usuario
        function actualizarBotonAdmin() {
            const btnPanelAdmin = document.getElementById('btnPanelAdmin');
            if (btnPanelAdmin) {
                if (esJefe()) {
                    btnPanelAdmin.style.visibility = 'visible';
                    btnPanelAdmin.style.width = 'auto';
                    btnPanelAdmin.style.minWidth = '80px';
                    btnPanelAdmin.style.padding = '0.5rem 1rem';
                    btnPanelAdmin.style.margin = '0';
                } else {
                    btnPanelAdmin.style.visibility = 'hidden';
                    btnPanelAdmin.style.width = '0';
                    btnPanelAdmin.style.minWidth = '0';
                    btnPanelAdmin.style.padding = '0.5rem 0';
                    btnPanelAdmin.style.margin = '0';
                    btnPanelAdmin.style.overflow = 'hidden';
                }
            }
        }

        // Cargar horas al iniciar
        cargarHoras();
        actualizarBotonAdmin();
    </script>
</body>
</html>

