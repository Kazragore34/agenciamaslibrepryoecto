<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entregas - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-fichaje.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="stats-container">
        <div class="fichaje-header">
            <h1>Entregas (Solo Sargentos)</h1>
            <div>
                <a href="menu.html" class="btn-primary">Menú</a>
                <a href="tickets_dinero.html" class="btn-primary">Tickets</a>
                <a href="armas.html" class="btn-primary">Armas</a>
                <a href="estadisticas.html" class="btn-primary">Estadísticas</a>
                <a id="btnPanelAdmin" href="admin.html" class="btn-primary" style="display: none;">Admin</a>
                <a id="btnEntregas" href="entregas.html" class="btn-primary" style="background: #059669;">Entregas</a>
                <a id="btnPerdidas" href="perdidas.html" class="btn-primary" style="display: none; background: #ef4444;">Pérdidas</a>
                <a href="perfil.html" class="btn-primary" style="background: #6b7280;">Mi Perfil</a>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Mensaje de acceso restringido -->
        <div id="mensajeNoSargento" style="display: none; margin-top: 2rem;">
            <div class="stats-card">
                <h3 style="color: #ef4444;">Acceso Restringido</h3>
                <p>Solo los sargentos pueden acceder a esta sección.</p>
            </div>
        </div>

        <!-- Sección: Tickets Pendientes de Confirmar (Sargento) -->
        <div id="seccionTicketsPendientes" style="margin-top: 2rem;">
            <div class="stats-card">
                <h2 style="margin-bottom: 1rem;">Confirmación de Dinero Entregado</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Aquí puedes confirmar los tickets de dinero que los prospects han entregado. Cuando un prospect entrega dinero, queda pendiente hasta que confirmes la cantidad recibida.</p>
                <div id="listaTicketsPendientes">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Acordeón: Historial de Entregas -->
        <div id="seccionHistorial" style="margin-top: 2rem;">
            <div class="stats-card">
                <h2 style="margin-bottom: 1rem;">Historial de Entregas</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Haz click en cada sección para ver el historial completo. Puedes confirmar el dinero entregado por cada entrega.</p>
                
                <!-- Acordeón de Productos -->
                <div class="accordion-item" style="margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden;">
                    <button class="accordion-header" onclick="toggleAccordion('productosHistorial')" style="width: 100%; padding: 1rem; background: #f9fafb; border: none; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">Productos Entregados</h3>
                        <span id="iconProductos" style="font-size: 1.25rem;">▼</span>
                    </button>
                    <div id="productosHistorial" class="accordion-content" style="display: none; padding: 1rem;">
                        <div id="historialProductos">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Acordeón de Armas -->
                <div class="accordion-item" style="margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden;">
                    <button class="accordion-header" onclick="toggleAccordion('armasHistorial')" style="width: 100%; padding: 1rem; background: #f9fafb; border: none; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">Armas Entregadas</h3>
                        <span id="iconArmas" style="font-size: 1.25rem;">▼</span>
                    </button>
                    <div id="armasHistorial" class="accordion-content" style="display: none; padding: 1rem;">
                        <div id="historialArmas">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="crypto-utils.js"></script>
    <script src="auth.js"></script>
    <script src="admin.js"></script>
    <script src="productos.js"></script>
    <script src="metas.js"></script>
    <script src="entregas.js"></script>
    <script src="armas.js"></script>
    <script src="tickets.js"></script>
    <script>
        requireAuth();
        
        const currentUser = getCurrentUser();
        
        // Verificar que sea sargento
        if (!esSargento()) {
            document.getElementById('mensajeNoSargento').style.display = 'block';
            document.getElementById('seccionTicketsPendientes').style.display = 'none';
            document.getElementById('seccionHistorial').style.display = 'none';
        } else {
            document.getElementById('mensajeNoSargento').style.display = 'none';
        }

        // Actualizar navegación según rol
        function actualizarNavegacion() {
            const btnPanelAdmin = document.getElementById('btnPanelAdmin');
            const btnPerdidas = document.getElementById('btnPerdidas');
            
            if (esAdmin()) {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'inline-block';
            } else {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'none';
            }
            
            if (esSargento()) {
                if (btnPerdidas) btnPerdidas.style.display = 'inline-block';
            } else {
                if (btnPerdidas) btnPerdidas.style.display = 'none';
            }
        }
        
        actualizarNavegacion();

        // Cargar tickets pendientes de confirmar por el sargento
        async function cargarTicketsPendientesDealer() {
            if (!esSargento()) return;
            
            try {
                const tickets = await obtenerTicketsPorDealer(currentUser.id);
                const ticketsPendientes = tickets.filter(t => t.estado === 'pendiente_dealer');
                
                const listaEl = document.getElementById('listaTicketsPendientes');
                
                if (ticketsPendientes.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay tickets pendientes de confirmar</p>';
                    return;
                }
                
                let html = '<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1rem; border-radius: 0.375rem;">';
                html += `<strong>⚠️ Tienes ${ticketsPendientes.length} ticket(s) pendiente(s) de confirmar</strong>`;
                html += '</div>';
                
                html += '<table class="data-table"><thead><tr><th>Ticket ID</th><th>Prospect</th><th>Monto Aprox</th><th>Monto Entregado</th><th>Fecha</th><th>Acción</th></tr></thead><tbody>';
                
                ticketsPendientes.forEach(ticket => {
                    const fecha = ticket.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                    
                    html += `<tr style="background: #fef3c7;">
                        <td><strong>${ticket.ticketId}</strong></td>
                        <td>${ticket.vendedorNombre}</td>
                        <td>${ticket.montoAprox ? '$' + ticket.montoAprox.toLocaleString() : 'N/A'}</td>
                        <td><strong style="color: #10b981;">$${ticket.montoEntregado.toLocaleString()}</strong></td>
                        <td>${fechaStr}</td>
                        <td>
                            <button class="btn-success btn-sm" onclick="confirmarTicketDealer('${ticket.id}')">Confirmar</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando tickets pendientes:', error);
            }
        }

        async function confirmarTicketDealer(ticketId) {
            if (!confirm('¿Confirmas que recibiste este dinero del prospect?')) return;
            try {
                await confirmarTicketDineroDealer(ticketId);
                alert('Ticket confirmado correctamente');
                cargarTicketsPendientesDealer();
            } catch (error) {
                alert(error.message);
            }
        }

        // Cargar historial de productos
        async function cargarHistorialProductos() {
            if (!esSargento()) return;
            
            try {
                console.log('Cargando historial de productos para sargento:', currentUser.id);
                const entregas = await obtenerEntregasPorDealer(currentUser.id);
                console.log('Entregas encontradas:', entregas.length);
                
                const listaEl = document.getElementById('historialProductos');
                
                if (!listaEl) {
                    console.error('Elemento historialProductos no encontrado');
                    return;
                }
                
                if (entregas.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay entregas de productos registradas</p>';
                    return;
                }
                
                // Ordenar por fecha (más recientes primero)
                entregas.sort((a, b) => {
                    const fechaA = a.fechaCreacion?.toDate() || new Date(0);
                    const fechaB = b.fechaCreacion?.toDate() || new Date(0);
                    return fechaB - fechaA;
                });
                
                let html = '<table class="data-table"><thead><tr><th>Prospect</th><th>Productos</th><th>Estado</th><th>Fecha</th><th>Acción</th></tr></thead><tbody>';
                
                entregas.forEach(entrega => {
                    const fecha = entrega.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                    const estadoClass = entrega.estado === 'confirmado' ? 'success' : entrega.estado === 'rechazado' ? 'error' : 'pendiente';
                    
                    // Buscar tickets relacionados
                    const tieneTicket = entrega.ticketsRelacionados && entrega.ticketsRelacionados.length > 0;
                    
                    html += `<tr>
                        <td><strong>${entrega.vendedorNombre}</strong></td>
                        <td>${entrega.productos.map(p => `${obtenerNombreProducto(p.tipo)}: ${p.cantidad}`).join(', ')}</td>
                        <td><span class="estado-badge ${estadoClass}">${entrega.estado}</span></td>
                        <td>${fechaStr}</td>
                        <td>
                            ${entrega.estado === 'confirmado' && !tieneTicket ? 
                                `<button class="btn-primary btn-sm" onclick="verDetallesEntrega('${entrega.id}')">Ver Detalles</button>` : 
                                entrega.estado === 'confirmado' && tieneTicket ? 
                                `<span style="color: #10b981; font-size: 0.875rem;">Ticket creado</span>` : 
                                ''
                            }
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando historial de productos:', error);
            }
        }

        async function verDetallesEntrega(entregaId) {
            // Mostrar detalles y permitir confirmar dinero
            const monto = prompt('El prospect ha entregado dinero por esta entrega. Ingresa el monto recibido:');
            if (!monto || isNaN(monto) || parseFloat(monto) <= 0) {
                alert('Monto inválido');
                return;
            }
            
            try {
                await crearTicketDinero(currentUser.id, entregaId, parseFloat(monto), [entregaId]);
                alert('Ticket de dinero creado. El prospect debe confirmar el monto.');
                cargarHistorialProductos();
            } catch (error) {
                alert(error.message);
            }
        }

        // Cargar historial de armas
        async function cargarHistorialArmas() {
            if (!esSargento()) return;
            
            try {
                console.log('Cargando historial de armas para sargento:', currentUser.id);
                const armas = await obtenerArmasPorDealer(currentUser.id);
                console.log('Armas encontradas:', armas.length);
                
                const listaEl = document.getElementById('historialArmas');
                
                if (!listaEl) {
                    console.error('Elemento historialArmas no encontrado');
                    return;
                }
                
                if (armas.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay armas entregadas registradas</p>';
                    return;
                }
                
                // Ordenar por fecha (más recientes primero)
                armas.sort((a, b) => {
                    const fechaA = a.fechaCreacion?.toDate() || new Date(0);
                    const fechaB = b.fechaCreacion?.toDate() || new Date(0);
                    return fechaB - fechaA;
                });
                
                let html = '<table class="data-table"><thead><tr><th>Tipo</th><th>Prospect</th><th>Balas</th><th>Chaleco</th><th>Estado</th><th>Fecha</th></tr></thead><tbody>';
                
                armas.forEach(arma => {
                    const fecha = arma.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                    const estadoClass = arma.estado === 'activa' ? 'success' : 'error';
                    
                    html += `<tr>
                        <td><strong>${arma.tipoArma}</strong></td>
                        <td>${arma.vendedorNombre}</td>
                        <td>${arma.cantidadBalasActual !== undefined ? arma.cantidadBalasActual : arma.cantidadBalasInicial || 0} / ${arma.cantidadBalasInicial || 0}</td>
                        <td>${arma.chaleco ? 'Sí' : 'No'}</td>
                        <td><span class="estado-badge ${estadoClass}">${arma.estado}</span></td>
                        <td>${fechaStr}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando historial de armas:', error);
            }
        }

        // Función para toggle del acordeón
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            let iconId = '';
            if (id === 'productosHistorial') {
                iconId = 'iconProductos';
            } else if (id === 'armasHistorial') {
                iconId = 'iconArmas';
            }
            const icon = document.getElementById(iconId);
            
            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                if (icon) icon.textContent = '▲';
                // Recargar datos cuando se expande
                if (id === 'productosHistorial') {
                    cargarHistorialProductos();
                } else if (id === 'armasHistorial') {
                    cargarHistorialArmas();
                }
            } else {
                content.style.display = 'none';
                if (icon) icon.textContent = '▼';
            }
        }

        // Inicializar - Solo sargentos pueden ver esto
        if (esSargento()) {
            cargarTicketsPendientesDealer();
            // No cargar historial automáticamente, solo cuando se expanda el acordeón
        }
    </script>
</body>
</html>
