<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entregas - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-fichaje.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="stats-container" style="padding-top: 6rem;">
        <div class="fichaje-header">
            <h1>Entregas (Solo Sargentos)</h1>
            <div>
                <a href="menu.html" class="btn-primary">Menú</a>
                <a href="tickets_dinero.html" class="btn-primary">Tickets</a>
                <a href="armas.html" class="btn-primary">Armas</a>
                <a href="estadisticas.html" class="btn-primary">Estadísticas</a>
                <a id="btnPanelAdmin" href="admin.html" class="btn-primary" style="display: none;">Admin</a>
                <a id="btnEntregas" href="entregas.html" class="btn-primary" style="background: #059669;">Entregas</a>
                <a id="btnPerdidas" href="perdidas.html" class="btn-primary" style="display: none; background: #ef4444;">Pérdidas</a>
                <a href="perfil.html" class="btn-primary" style="background: #6b7280;">Mi Perfil</a>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Mensaje de acceso restringido -->
        <div id="mensajeNoSargento" style="display: none; margin-top: 2rem;">
            <div class="stats-card">
                <h3 style="color: #ef4444;">Acceso Restringido</h3>
                <p>Solo los sargentos pueden acceder a esta sección.</p>
            </div>
        </div>

        <!-- Sección: Tickets Pendientes de Confirmar (Sargento) -->
        <div id="seccionTicketsPendientes" style="margin-top: 2rem;">
            <div class="stats-card">
                <h2 style="margin-bottom: 1rem;">Confirmación de Dinero Entregado</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Aquí puedes confirmar los tickets de dinero que los prospects han entregado. Cuando un prospect entrega dinero, queda pendiente hasta que confirmes la cantidad recibida.</p>
                <div id="listaTicketsPendientes">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Sección: Solicitudes de Balas Pendientes (Sargento) -->
        <div id="seccionSolicitudesBalas" style="margin-top: 2rem;">
            <div class="stats-card">
                <h2 style="margin-bottom: 1rem;">Solicitudes de Balas Pendientes</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Aquí puedes ver y confirmar las solicitudes de balas que los prospects han realizado para sus armas activas.</p>
                <div id="listaSolicitudesBalas">
                    <!-- Se carga dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Acordeón: Historial de Entregas -->
        <div id="seccionHistorial" style="margin-top: 2rem;">
            <div class="stats-card">
                <h2 style="margin-bottom: 1rem;">Historial de Entregas</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Haz click en cada sección para ver el historial completo. Puedes confirmar el dinero entregado por cada entrega.</p>
                
                <!-- Acordeón de Productos -->
                <div class="accordion-item" style="margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden;">
                    <button class="accordion-header" onclick="toggleAccordion('productosHistorial')" style="width: 100%; padding: 1rem; background: #f9fafb; border: none; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">Productos Entregados</h3>
                        <span id="iconProductos" style="font-size: 1.25rem;">▼</span>
                    </button>
                    <div id="productosHistorial" class="accordion-content" style="display: none; padding: 1rem;">
                        <div id="historialProductos">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Acordeón de Armas -->
                <div class="accordion-item" style="margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden;">
                    <button class="accordion-header" onclick="toggleAccordion('armasHistorial')" style="width: 100%; padding: 1rem; background: #f9fafb; border: none; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">Armas Entregadas</h3>
                        <span id="iconArmas" style="font-size: 1.25rem;">▼</span>
                    </button>
                    <div id="armasHistorial" class="accordion-content" style="display: none; padding: 1rem;">
                        <div id="historialArmas">
                            <!-- Se carga dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="crypto-utils.js"></script>
    <script src="auth.js"></script>
    <script src="admin.js"></script>
    <script src="productos.js"></script>
    <script src="metas.js"></script>
    <script src="entregas.js"></script>
    <script src="armas.js"></script>
    <script src="tickets.js"></script>
    <script>
        requireAuth();
        
        const currentUser = getCurrentUser();
        
        // Verificar que sea sargento o admin
        if (!esSargentoOAdmin()) {
            document.getElementById('mensajeNoSargento').style.display = 'block';
            document.getElementById('seccionTicketsPendientes').style.display = 'none';
            document.getElementById('seccionSolicitudesBalas').style.display = 'none';
            document.getElementById('seccionHistorial').style.display = 'none';
        } else {
            document.getElementById('mensajeNoSargento').style.display = 'none';
        }

        // Actualizar navegación según rol
        function actualizarNavegacion() {
            const btnPanelAdmin = document.getElementById('btnPanelAdmin');
            const btnEntregas = document.getElementById('btnEntregas');
            const btnPerdidas = document.getElementById('btnPerdidas');
            
            if (esAdmin()) {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'inline-block';
            } else {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'none';
            }
            
            if (esSargentoOAdmin()) {
                if (btnEntregas) btnEntregas.style.display = 'inline-block';
                if (btnPerdidas) btnPerdidas.style.display = 'inline-block';
            } else {
                if (btnEntregas) btnEntregas.style.display = 'none';
                if (btnPerdidas) btnPerdidas.style.display = 'none';
            }
        }
        
        actualizarNavegacion();

        // Cargar tickets pendientes de confirmar por el sargento/admin
        async function cargarTicketsPendientesDealer() {
            if (!esSargentoOAdmin()) return;
            
            try {
                const tickets = await obtenerTicketsPorDealer(currentUser.id);
                const ticketsPendientes = tickets.filter(t => t.estado === 'pendiente_dealer');
                
                const listaEl = document.getElementById('listaTicketsPendientes');
                
                if (ticketsPendientes.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay tickets pendientes de confirmar</p>';
                    return;
                }
                
                let html = '<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1rem; border-radius: 0.375rem;">';
                html += `<strong>⚠️ Tienes ${ticketsPendientes.length} ticket(s) pendiente(s) de confirmar</strong>`;
                html += '</div>';
                
                html += '<table class="data-table"><thead><tr><th>Ticket ID</th><th>Prospect</th><th>Monto Aprox</th><th>Monto Entregado</th><th>Fecha</th><th>Acción</th></tr></thead><tbody>';
                
                ticketsPendientes.forEach(ticket => {
                    const fecha = ticket.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                    
                    html += `<tr style="background: #fef3c7;">
                        <td><strong>${ticket.ticketId}</strong></td>
                        <td>${ticket.vendedorNombre}</td>
                        <td>${ticket.montoAprox ? '$' + ticket.montoAprox.toLocaleString() : 'N/A'}</td>
                        <td><strong style="color: #10b981;">$${ticket.montoEntregado.toLocaleString()}</strong></td>
                        <td>${fechaStr}</td>
                        <td>
                            <button class="btn-success btn-sm" onclick="confirmarTicketDealer('${ticket.id}')" style="margin-right: 0.5rem;">Confirmar</button>
                            <button class="btn-danger btn-sm" onclick="rechazarTicketDealer('${ticket.id}')">Rechazar</button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando tickets pendientes:', error);
            }
        }

        async function confirmarTicketDealer(ticketId) {
            if (!confirm('¿Confirmas que recibiste este dinero del prospect?')) return;
            try {
                await confirmarTicketDineroDealer(ticketId);
                alert('Ticket confirmado correctamente');
                cargarTicketsPendientesDealer();
            } catch (error) {
                alert(error.message);
            }
        }

        async function rechazarTicketDealer(ticketId) {
            const motivo = prompt('Motivo del rechazo (opcional):');
            if (motivo === null) return; // Usuario canceló
            
            if (!confirm('¿Estás seguro de rechazar este ticket? El prospect podrá crear uno nuevo con un monto diferente.')) return;
            
            try {
                await rechazarTicketDineroDealer(ticketId, motivo || '');
                alert('Ticket rechazado. El prospect podrá crear un nuevo ticket.');
                cargarTicketsPendientesDealer();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Cargar solicitudes de balas pendientes
        async function cargarSolicitudesBalasPendientes() {
            if (!esSargentoOAdmin()) return;
            
            try {
                console.log('Cargando solicitudes de balas pendientes...');
                const armasConSolicitudes = await obtenerSolicitudesBalasPendientes();
                console.log('Armas con solicitudes encontradas:', armasConSolicitudes.length);
                const listaEl = document.getElementById('listaSolicitudesBalas');
                
                if (!listaEl) {
                    console.error('Elemento listaSolicitudesBalas no encontrado');
                    return;
                }
                
                if (armasConSolicitudes.length === 0) {
                    console.log('No hay solicitudes de balas pendientes');
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay solicitudes de balas pendientes</p>';
                    return;
                }
                
                let html = '<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1rem; border-radius: 0.375rem;">';
                html += `<strong>⚠️ Tienes ${armasConSolicitudes.length} arma(s) con solicitudes de balas pendientes</strong>`;
                html += '</div>';
                
                html += '<div style="display: grid; gap: 1rem;">';
                
                armasConSolicitudes.forEach(arma => {
                    const fechaCreacion = arma.fechaCreacion?.toDate();
                    const fechaCreacionStr = fechaCreacion ? fechaCreacion.toLocaleString('es-PE') : 'N/A';
                    
                    html += `<div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: #fef3c7;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">`;
                    html += `<div>`;
                    html += `<h3 style="margin: 0 0 0.5rem 0;">${arma.tipoArma} ${arma.chaleco ? '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-left: 0.5rem;">Con Chaleco</span>' : ''}</h3>`;
                    html += `<p style="color: #6b7280; margin: 0; font-size: 0.875rem;">Prospect: <strong>${arma.vendedorNombre}</strong></p>`;
                    html += `<p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.875rem;">Fecha de entrega: ${fechaCreacionStr}</p>`;
                    html += `<p style="color: #6b7280; margin: 0.25rem 0 0 0; font-size: 0.875rem;">Balas actuales: <strong>${arma.cantidadBalasActual !== undefined ? arma.cantidadBalasActual : arma.cantidadBalasInicial || 0} / ${arma.cantidadBalasInicial || 0}</strong></p>`;
                    html += `</div>`;
                    html += `<span class="estado-badge pendiente">${arma.solicitudesPendientes.length} solicitud(es)</span>`;
                    html += `</div>`;
                    
                    html += `<div style="margin-top: 1rem;">`;
                    html += `<h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: #374151;">Solicitudes Pendientes:</h4>`;
                    html += `<div style="display: grid; gap: 0.5rem;">`;
                    
                    // Iterar sobre todas las solicitudes y mostrar solo las pendientes
                    (arma.solicitudesBalas || []).forEach((solicitud, solicitudIndex) => {
                        if (solicitud.estado !== 'pendiente') return;
                        
                        const fechaSolicitud = solicitud.fecha?.toDate();
                        const fechaSolicitudStr = fechaSolicitud ? fechaSolicitud.toLocaleString('es-PE') : 'N/A';
                        
                        html += `<div style="background: white; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; display: flex; justify-content: space-between; align-items: center;">`;
                        html += `<div>`;
                        html += `<p style="margin: 0; font-weight: 500;">Cantidad: <strong>${solicitud.cantidad}</strong> balas</p>`;
                        html += `<p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">Solicitado: ${fechaSolicitudStr}</p>`;
                        html += `${solicitud.sargentoNombre ? `<p style="margin: 0.25rem 0 0 0; color: #059669; font-size: 0.875rem;"><strong>Entregado por:</strong> ${solicitud.sargentoNombre}</p>` : ''}`;
                        html += `</div>`;
                        html += `${solicitud.estado === 'pendiente' ? `<button class="btn-success btn-sm" onclick="confirmarEntregaBalas('${arma.id}', ${solicitudIndex})">Confirmar Entrega</button>` : `<span class="estado-badge success">Entregado</span>`}`;
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                
                html += '</div>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando solicitudes de balas:', error);
                document.getElementById('listaSolicitudesBalas').innerHTML = 
                    '<p style="color: #ef4444;">Error cargando solicitudes de balas: ' + error.message + '</p>';
            }
        }

        async function confirmarEntregaBalas(armaId, solicitudIndex) {
            if (!confirm('¿Confirmas que entregaste estas balas al prospect?')) return;
            try {
                await entregarBalas(armaId, solicitudIndex);
                alert('Balas confirmadas como entregadas correctamente');
                cargarSolicitudesBalasPendientes();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Cargar historial de productos
        async function cargarHistorialProductos() {
            if (!esSargentoOAdmin()) return;
            
            try {
                console.log('Cargando historial de productos para sargento:', currentUser.id);
                const entregas = await obtenerEntregasPorDealer(currentUser.id);
                console.log('Entregas encontradas:', entregas.length);
                
                const listaEl = document.getElementById('historialProductos');
                
                if (!listaEl) {
                    console.error('Elemento historialProductos no encontrado');
                    return;
                }
                
                if (entregas.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay entregas de productos registradas</p>';
                    return;
                }
                
                // Ordenar por fecha (más recientes primero)
                entregas.sort((a, b) => {
                    const fechaA = a.fechaCreacion?.toDate() || new Date(0);
                    const fechaB = b.fechaCreacion?.toDate() || new Date(0);
                    return fechaB - fechaA;
                });
                
                let html = '<table class="data-table"><thead><tr><th>Sargento</th><th>Prospect</th><th>Productos</th><th>Monto Aprox</th><th>Estado</th><th>Fecha</th><th>Acción</th></tr></thead><tbody>';
                
                entregas.forEach(entrega => {
                    const fecha = entrega.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                    const estadoClass = entrega.estado === 'confirmado' ? 'success' : entrega.estado === 'rechazado' ? 'error' : 'pendiente';
                    const esMiEntrega = entrega.dealerId === currentUser.id;
                    
                    // Buscar tickets relacionados
                    const tieneTicket = entrega.ticketsRelacionados && entrega.ticketsRelacionados.length > 0;
                    
                    html += `<tr>
                        <td><strong>${entrega.dealerNombre}</strong></td>
                        <td><strong>${entrega.vendedorNombre}</strong></td>
                        <td>${entrega.productos.map(p => `${obtenerNombreProducto(p.tipo)}: ${p.cantidad}`).join(', ')}</td>
                        <td>${entrega.precioAprox ? '$' + entrega.precioAprox.toLocaleString() : 'N/A'}</td>
                        <td><span class="estado-badge ${estadoClass}">${entrega.estado}</span></td>
                        <td>${fechaStr}</td>
                        <td>
                            ${entrega.estado === 'confirmado' && !tieneTicket && esMiEntrega ? 
                                `<button class="btn-primary btn-sm" onclick="verDetallesEntrega('${entrega.id}')">Ver Detalles</button>` : 
                                entrega.estado === 'confirmado' && tieneTicket ? 
                                `<span style="color: #10b981; font-size: 0.875rem;">Ticket creado</span>` : 
                                entrega.estado === 'confirmado' && !esMiEntrega ?
                                `<span style="color: #6b7280; font-size: 0.875rem;">Solo el sargento que entregó puede ver detalles</span>` :
                                ''
                            }
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando historial de productos:', error);
            }
        }

        async function verDetallesEntrega(entregaId) {
            try {
                await ensureDb();
                const entregaDoc = await db.collection('entregas_productos').doc(entregaId).get();
                
                if (!entregaDoc.exists) {
                    alert('Entrega no encontrada');
                    return;
                }
                
                const entrega = { id: entregaDoc.id, ...entregaDoc.data() };
                
                // Obtener tickets relacionados
                const tickets = await obtenerTicketsPorDealer(currentUser.id);
                const ticketsRelacionados = tickets.filter(t => 
                    t.entregasRelacionadas && t.entregasRelacionadas.includes(entregaId)
                );
                
                const fecha = entrega.fechaCreacion?.toDate();
                const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                const fechaConfirmacion = entrega.fechaConfirmacion?.toDate();
                const fechaConfirmacionStr = fechaConfirmacion ? fechaConfirmacion.toLocaleString('es-PE') : 'N/A';
                
                let html = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 2rem;">
                        <div style="background: white; border-radius: 0.5rem; padding: 2rem; max-width: 600px; max-height: 90vh; overflow-y: auto; width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="margin: 0;">Detalles de Entrega</h2>
                                <button onclick="cerrarModalDetalles()" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer;">Cerrar</button>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <p><strong>Prospect:</strong> ${entrega.vendedorNombre}</p>
                                <p><strong>Estado:</strong> <span class="estado-badge ${entrega.estado === 'confirmado' ? 'success' : entrega.estado === 'rechazado' ? 'error' : 'pendiente'}">${entrega.estado}</span></p>
                                <p><strong>Fecha de creación:</strong> ${fechaStr}</p>
                                ${entrega.estado === 'confirmado' ? `<p><strong>Fecha de confirmación:</strong> ${fechaConfirmacionStr}</p>` : ''}
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Productos:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${entrega.productos.map(p => `<li>${obtenerNombreProducto(p.tipo)}: ${p.cantidad}${p.precioAprox ? ` (Precio aprox: $${p.precioAprox.toLocaleString()})` : ''}</li>`).join('')}
                                </ul>
                            </div>
                            
                            ${entrega.itemsAdicionales && entrega.itemsAdicionales.length > 0 ? `
                                <div style="margin-bottom: 1rem;">
                                    <strong>Items Adicionales:</strong>
                                    <ul style="margin: 0.5rem 0 0 1.5rem;">
                                        ${entrega.itemsAdicionales.map(i => `<li>${i.tipo}: ${i.cantidad}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${entrega.notas ? `<div style="margin-bottom: 1rem;"><strong>Notas:</strong> ${entrega.notas}</div>` : ''}
                            
                            ${ticketsRelacionados.length > 0 ? `
                                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                                    <strong>Tickets de Dinero Relacionados:</strong>
                                    <div style="margin-top: 0.5rem;">
                                        ${ticketsRelacionados.map(ticket => {
                                            const fechaTicket = ticket.fechaCreacion?.toDate();
                                            const fechaTicketStr = fechaTicket ? fechaTicket.toLocaleString('es-PE') : 'N/A';
                                            const estadoClass = ticket.estado === 'confirmado' ? 'success' : ticket.estado === 'rechazado' ? 'error' : 'pendiente';
                                            return `
                                                <div style="background: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                                                    <p style="margin: 0;"><strong>${ticket.ticketId}</strong> - <span class="estado-badge ${estadoClass}">${ticket.estado}</span></p>
                                                    <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.875rem;">Monto: $${ticket.montoEntregado ? ticket.montoEntregado.toLocaleString() : 'N/A'} - ${fechaTicketStr}</p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Crear modal si no existe
                let modal = document.getElementById('modalDetallesEntrega');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'modalDetallesEntrega';
                    document.body.appendChild(modal);
                }
                modal.innerHTML = html;
            } catch (error) {
                console.error('Error cargando detalles:', error);
                alert('Error cargando detalles: ' + error.message);
            }
        }
        
        function cerrarModalDetalles() {
            const modal = document.getElementById('modalDetallesEntrega');
            if (modal) {
                modal.remove();
            }
        }

        // Cargar historial de armas
        async function cargarHistorialArmas() {
            if (!esSargentoOAdmin()) return;
            
            try {
                console.log('Cargando historial de armas para sargento:', currentUser.id);
                const armas = await obtenerArmasPorDealer(currentUser.id);
                console.log('Armas encontradas:', armas.length);
                
                const listaEl = document.getElementById('historialArmas');
                
                if (!listaEl) {
                    console.error('Elemento historialArmas no encontrado');
                    return;
                }
                
                if (armas.length === 0) {
                    listaEl.innerHTML = '<p style="color: #6b7280;">No hay armas entregadas registradas</p>';
                    return;
                }
                
                // Ordenar por fecha (más recientes primero)
                armas.sort((a, b) => {
                    const fechaA = a.fechaCreacion?.toDate() || new Date(0);
                    const fechaB = b.fechaCreacion?.toDate() || new Date(0);
                    return fechaB - fechaA;
                });
                
                let html = '<table class="data-table"><thead><tr><th>Tipo</th><th>Prospect</th><th>Balas</th><th>Chaleco</th><th>Estado</th><th>Fecha</th></tr></thead><tbody>';
                
                armas.forEach(arma => {
                    const fecha = arma.fechaCreacion?.toDate();
                    const fechaStr = fecha ? fecha.toLocaleString('es-PE') : 'N/A';
                    const estadoClass = arma.estado === 'activa' ? 'success' : 'error';
                    
                    html += `<tr>
                        <td><strong>${arma.tipoArma}</strong></td>
                        <td>${arma.vendedorNombre}</td>
                        <td>${arma.cantidadBalasActual !== undefined ? arma.cantidadBalasActual : arma.cantidadBalasInicial || 0} / ${arma.cantidadBalasInicial || 0}</td>
                        <td>${arma.chaleco ? 'Sí' : 'No'}</td>
                        <td><span class="estado-badge ${estadoClass}">${arma.estado}</span></td>
                        <td>${fechaStr}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                listaEl.innerHTML = html;
            } catch (error) {
                console.error('Error cargando historial de armas:', error);
            }
        }

        // Función para toggle del acordeón
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            let iconId = '';
            if (id === 'productosHistorial') {
                iconId = 'iconProductos';
            } else if (id === 'armasHistorial') {
                iconId = 'iconArmas';
            }
            const icon = document.getElementById(iconId);
            
            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                if (icon) icon.textContent = '▲';
                // Recargar datos cuando se expande
                if (id === 'productosHistorial') {
                    cargarHistorialProductos();
                } else if (id === 'armasHistorial') {
                    cargarHistorialArmas();
                }
            } else {
                content.style.display = 'none';
                if (icon) icon.textContent = '▼';
            }
        }

        // Inicializar - Solo sargentos y admins pueden ver esto
        if (esSargentoOAdmin()) {
            cargarTicketsPendientesDealer();
            // Cargar solicitudes de balas inmediatamente
            setTimeout(() => {
                cargarSolicitudesBalasPendientes();
            }, 1000);
            // Recargar cada 3 segundos para asegurar que se vean las nuevas solicitudes
            setInterval(() => {
                cargarSolicitudesBalasPendientes();
            }, 3000);
            // No cargar historial automáticamente, solo cuando se expanda el acordeón
        }
    </script>
</body>
</html>
