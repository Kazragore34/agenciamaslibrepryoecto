<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas de Ventas - Sistema de Control</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles-fichaje.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="stats-container" style="padding-top: 6rem;">
        <div class="fichaje-header">
            <h1>Estadísticas de Ventas</h1>
            <div>
                <a href="menu.html" class="btn-primary">Menú</a>
                <a href="tickets_dinero.html" class="btn-primary">Tickets</a>
                <a href="armas.html" class="btn-primary">Armas</a>
                <a href="estadisticas.html" class="btn-primary">Estadísticas</a>
                <a id="btnPanelAdmin" href="admin.html" class="btn-primary" style="display: none;">Admin</a>
                <a id="btnEntregas" href="entregas.html" class="btn-primary" style="display: none;">Entregas</a>
                <a id="btnPerdidas" href="perdidas.html" class="btn-primary" style="display: none; background: #ef4444;">Pérdidas</a>
                <a href="perfil.html" class="btn-primary" style="background: #6b7280;">Mi Perfil</a>
                <button class="btn-logout" onclick="logout()">Cerrar Sesión</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stats-card">
                <h3>TOP</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Todos los roles - Dinero negro total (productos + entrega de dinero)</p>
                <div id="topGeneralTable"></div>
            </div>

            <div class="stats-card">
                <h3>TOP ROBOS</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Top de dinero negro por robos (solo depósitos)</p>
                <div id="topRobosTable"></div>
            </div>
        </div>

        <div class="stats-grid" style="margin-top: 2rem;">
            <div class="stats-card">
                <h3>TOP VENTAS</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Top de dinero por productos vendidos (solo tickets)</p>
                <div id="topVentasTable"></div>
            </div>

            <div class="stats-card">
                <h3>Productos Más Entregados</h3>
                <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">Lista de productos más vendidos</p>
                <div id="productosMasTable"></div>
            </div>
        </div>

        <div class="stats-card" style="margin-top: 2rem;">
            <h3>Dinero Entregado por Día (Últimos 30 días)</h3>
            <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.9rem;">Dinero total entregado por prospects por día</p>
            <div style="position: relative; height: 400px;">
                <canvas id="dineroDiasChart"></canvas>
            </div>
        </div>

        <div class="stats-card" style="margin-top: 2rem;">
            <h3>Dinero Entregado por Semana</h3>
            <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.9rem;">Dinero total entregado por semana (tickets + depósitos)</p>
            <div style="position: relative; height: 400px;">
                <canvas id="dineroSemanasChart"></canvas>
            </div>
        </div>

        <div class="stats-card" style="margin-top: 2rem;">
            <h3>Entregas por Día (Últimos 30 días)</h3>
            <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.9rem;">Cantidad de entregas confirmadas por día</p>
            <div style="position: relative; height: 400px;">
                <canvas id="entregasDiasChart"></canvas>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>
    <script src="crypto-utils.js"></script>
    <script src="auth.js"></script>
    <script src="admin.js"></script>
    <script src="productos.js"></script>
    <script src="metas.js"></script>
    <script src="tickets.js"></script>
    <script src="entregas.js"></script>
    <script>
        requireAuth();
        
        // Actualizar navegación según rol
        function actualizarNavegacion() {
            const btnPanelAdmin = document.getElementById('btnPanelAdmin');
            const btnEntregas = document.getElementById('btnEntregas');
            const btnPerdidas = document.getElementById('btnPerdidas');
            
            if (esAdmin()) {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'inline-block';
            } else {
                if (btnPanelAdmin) btnPanelAdmin.style.display = 'none';
            }
            
            if (esSargentoOAdmin()) {
                if (btnEntregas) btnEntregas.style.display = 'inline-block';
                if (btnPerdidas) btnPerdidas.style.display = 'inline-block';
            } else {
                if (btnEntregas) btnEntregas.style.display = 'none';
                if (btnPerdidas) btnPerdidas.style.display = 'none';
            }
        }
        actualizarNavegacion();

        let dineroDiasChart = null;
        let dineroSemanasChart = null;
        let entregasDiasChart = null;

        async function cargarEstadisticas() {
            try {
                await ensureDb();
                
                // Cargar TOP (todos los roles - dinero negro total)
                const topGeneral = await obtenerTopGeneral();
                mostrarTopGeneral(topGeneral);

                // Cargar TOP ROBOS (solo depósitos)
                const topRobos = await obtenerTopRobos();
                mostrarTopRobos(topRobos);

                // Cargar TOP VENTAS (solo tickets)
                const topVentas = await obtenerTopVentas();
                mostrarTopVentas(topVentas);

                // Cargar productos más entregados
                const productosMas = await obtenerProductosMasEntregados();
                mostrarProductosMas(productosMas);

                // Cargar gráficas
                await cargarGraficasDinero();
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        // TOP: Todos los roles - Dinero negro total (productos + entrega de dinero)
        async function obtenerTopGeneral() {
            try {
                const usuariosMap = {};
                
                // Obtener todos los usuarios para tener sus roles
                const usuariosSnapshot = await db.collection('users').get();
                const usuariosData = {};
                usuariosSnapshot.forEach(doc => {
                    usuariosData[doc.id] = doc.data();
                });
                
                // Obtener tickets confirmados
                const ticketsSnapshot = await db.collection('tickets_dinero')
                    .where('estado', '==', 'confirmado')
                    .get();
                
                ticketsSnapshot.forEach(doc => {
                    const ticket = doc.data();
                    const usuarioId = ticket.vendedorId;
                    const monto = ticket.montoEntregado || 0;
                    const usuarioData = usuariosData[usuarioId];
                    
                    if (!usuariosMap[usuarioId]) {
                        usuariosMap[usuarioId] = {
                            usuarioId,
                            usuarioNombre: ticket.vendedorNombre,
                            rol: usuarioData?.rol || 'N/A',
                            total: 0,
                            tickets: 0,
                            depositos: 0
                        };
                    }
                    usuariosMap[usuarioId].total += monto;
                    usuariosMap[usuarioId].tickets += 1;
                });
                
                // Obtener depósitos aprobados
                const depositosSnapshot = await db.collection('depositos_dinero_negro')
                    .where('estado', '==', 'aprobado')
                    .get();
                
                depositosSnapshot.forEach(doc => {
                    const deposito = doc.data();
                    const usuarioId = deposito.usuarioId;
                    const monto = deposito.montoTotal || 0;
                    const usuarioData = usuariosData[usuarioId];
                    
                    if (!usuariosMap[usuarioId]) {
                        usuariosMap[usuarioId] = {
                            usuarioId,
                            usuarioNombre: deposito.usuarioNombre,
                            rol: usuarioData?.rol || 'N/A',
                            total: 0,
                            tickets: 0,
                            depositos: 0
                        };
                    }
                    usuariosMap[usuarioId].total += monto;
                    usuariosMap[usuarioId].depositos += 1;
                });
                
                const usuarios = Object.values(usuariosMap);
                usuarios.sort((a, b) => b.total - a.total);
                
                return usuarios.slice(0, 10);
            } catch (error) {
                console.error('Error obteniendo top general:', error);
                return [];
            }
        }

        function mostrarTopGeneral(datos) {
            const container = document.getElementById('topGeneralTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Usuario</th>
                            <th>Rol</th>
                            <th>Total</th>
                            <th>Tickets</th>
                            <th>Depósitos</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                const rankClass = index === 0 ? 'oro' : index === 1 ? 'plata' : index === 2 ? 'bronce' : '';
                html += `
                    <tr>
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>${item.usuarioNombre}</td>
                        <td>${item.rol}</td>
                        <td><strong>$${item.total.toLocaleString()}</strong></td>
                        <td>${item.tickets}</td>
                        <td>${item.depositos}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // TOP ROBOS: Solo depósitos (dinero negro por robos)
        async function obtenerTopRobos() {
            try {
                const snapshot = await db.collection('depositos_dinero_negro')
                    .where('estado', '==', 'aprobado')
                    .get();
                
                const usuariosMap = {};
                
                snapshot.forEach(doc => {
                    const deposito = doc.data();
                    const usuarioId = deposito.usuarioId;
                    const usuarioNombre = deposito.usuarioNombre;
                    const monto = deposito.montoTotal || 0;
                    
                    if (!usuariosMap[usuarioId]) {
                        usuariosMap[usuarioId] = {
                            usuarioId,
                            usuarioNombre,
                            total: 0,
                            depositos: 0
                        };
                    }
                    usuariosMap[usuarioId].total += monto;
                    usuariosMap[usuarioId].depositos += 1;
                });
                
                const usuarios = Object.values(usuariosMap);
                usuarios.sort((a, b) => b.total - a.total);
                
                return usuarios.slice(0, 10);
            } catch (error) {
                console.error('Error obteniendo top robos:', error);
                return [];
            }
        }

        function mostrarTopRobos(datos) {
            const container = document.getElementById('topRobosTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Usuario</th>
                            <th>Total</th>
                            <th>Depósitos</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                const rankClass = index === 0 ? 'oro' : index === 1 ? 'plata' : index === 2 ? 'bronce' : '';
                html += `
                    <tr>
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>${item.usuarioNombre}</td>
                        <td><strong>$${item.total.toLocaleString()}</strong></td>
                        <td>${item.depositos}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // TOP VENTAS: Solo tickets (productos vendidos)
        async function obtenerTopVentas() {
            try {
                const snapshot = await db.collection('tickets_dinero')
                    .where('estado', '==', 'confirmado')
                    .get();
                
                const usuariosMap = {};
                
                snapshot.forEach(doc => {
                    const ticket = doc.data();
                    const usuarioId = ticket.vendedorId;
                    const usuarioNombre = ticket.vendedorNombre;
                    const monto = ticket.montoEntregado || 0;
                    
                    if (!usuariosMap[usuarioId]) {
                        usuariosMap[usuarioId] = {
                            usuarioId,
                            usuarioNombre,
                            total: 0,
                            tickets: 0
                        };
                    }
                    usuariosMap[usuarioId].total += monto;
                    usuariosMap[usuarioId].tickets += 1;
                });
                
                const usuarios = Object.values(usuariosMap);
                usuarios.sort((a, b) => b.total - a.total);
                
                return usuarios.slice(0, 10);
            } catch (error) {
                console.error('Error obteniendo top ventas:', error);
                return [];
            }
        }

        function mostrarTopVentas(datos) {
            const container = document.getElementById('topVentasTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Usuario</th>
                            <th>Total</th>
                            <th>Tickets</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                const rankClass = index === 0 ? 'oro' : index === 1 ? 'plata' : index === 2 ? 'bronce' : '';
                html += `
                    <tr>
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>${item.usuarioNombre}</td>
                        <td><strong>$${item.total.toLocaleString()}</strong></td>
                        <td>${item.tickets}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        async function obtenerProductosMasEntregados() {
            try {
                const snapshot = await db.collection('entregas_productos')
                    .where('estado', '==', 'confirmado')
                    .get();
                
                const productosMap = {};
                
                snapshot.forEach(doc => {
                    const entrega = doc.data();
                    entrega.productos.forEach(producto => {
                        const tipo = producto.tipo;
                        const cantidad = producto.cantidad || 0;
                        
                        if (!productosMap[tipo]) {
                            productosMap[tipo] = {
                                tipo,
                                nombre: obtenerNombreProducto(tipo),
                                cantidad: 0
                            };
                        }
                        productosMap[tipo].cantidad += cantidad;
                    });
                });
                
                const productos = Object.values(productosMap);
                productos.sort((a, b) => b.cantidad - a.cantidad);
                
                return productos.slice(0, 10);
            } catch (error) {
                console.error('Error obteniendo productos más entregados:', error);
                return [];
            }
        }

        async function obtenerEstadoEntregas() {
            try {
                const snapshot = await db.collection('entregas_productos').get();
                
                let confirmadas = 0;
                let pendientes = 0;
                let rechazadas = 0;
                
                snapshot.forEach(doc => {
                    const estado = doc.data().estado;
                    if (estado === 'confirmado') confirmadas++;
                    else if (estado === 'pendiente') pendientes++;
                    else if (estado === 'rechazado') rechazadas++;
                });
                
                return {
                    confirmadas,
                    pendientes,
                    rechazadas,
                    total: confirmadas + pendientes + rechazadas
                };
            } catch (error) {
                console.error('Error obteniendo estado de entregas:', error);
                return { confirmadas: 0, pendientes: 0, rechazadas: 0, total: 0 };
            }
        }

        async function cargarGraficasDinero() {
            try {
                const datosDias = await obtenerDineroPorDias();
                mostrarGraficaDias(datosDias);
                
                const datosSemanas = await obtenerDineroPorSemanas();
                mostrarGraficaSemanas(datosSemanas);
            } catch (error) {
                console.error('Error cargando gráficas:', error);
            }
        }

        async function cargarGraficasEntregas() {
            try {
                const datosDias = await obtenerEntregasPorDias();
                mostrarGraficaEntregasDias(datosDias);
            } catch (error) {
                console.error('Error cargando gráficas de entregas:', error);
            }
        }

        async function obtenerDineroPorDias() {
            try {
                const diasMap = {};
                const hoy = new Date();
                
                // Inicializar últimos 30 días
                for (let i = 29; i >= 0; i--) {
                    const fecha = new Date(hoy);
                    fecha.setDate(fecha.getDate() - i);
                    const fechaStr = fecha.toISOString().split('T')[0];
                    diasMap[fechaStr] = 0;
                }
                
                // Obtener tickets confirmados
                const ticketsSnapshot = await db.collection('tickets_dinero')
                    .where('estado', '==', 'confirmado')
                    .get();
                
                ticketsSnapshot.forEach(doc => {
                    const ticket = doc.data();
                    const fechaConfirmacion = ticket.fechaConfirmacion?.toDate();
                    if (fechaConfirmacion) {
                        const fechaStr = fechaConfirmacion.toISOString().split('T')[0];
                        if (diasMap.hasOwnProperty(fechaStr)) {
                            diasMap[fechaStr] += ticket.montoEntregado || 0;
                        }
                    }
                });
                
                // Obtener depósitos aprobados
                const depositosSnapshot = await db.collection('depositos_dinero_negro')
                    .where('estado', '==', 'aprobado')
                    .get();
                
                depositosSnapshot.forEach(doc => {
                    const deposito = doc.data();
                    const fechaAprobacion = deposito.fechaAprobacion?.toDate();
                    if (fechaAprobacion) {
                        const fechaStr = fechaAprobacion.toISOString().split('T')[0];
                        if (diasMap.hasOwnProperty(fechaStr)) {
                            diasMap[fechaStr] += deposito.montoTotal || 0;
                        }
                    }
                });
                
                return Object.keys(diasMap).map(fecha => ({
                    fecha: new Date(fecha).toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit' }),
                    dinero: diasMap[fecha]
                }));
            } catch (error) {
                console.error('Error obteniendo dinero por días:', error);
                return [];
            }
        }

        async function obtenerDineroPorSemanas() {
            try {
                const semanasMap = {};
                
                // Obtener tickets confirmados
                const ticketsSnapshot = await db.collection('tickets_dinero')
                    .where('estado', '==', 'confirmado')
                    .get();
                
                ticketsSnapshot.forEach(doc => {
                    const ticket = doc.data();
                    const fechaConfirmacion = ticket.fechaConfirmacion?.toDate();
                    if (fechaConfirmacion) {
                        const semana = getSemanaActual(fechaConfirmacion);
                        if (!semanasMap[semana]) {
                            semanasMap[semana] = 0;
                        }
                        semanasMap[semana] += ticket.montoEntregado || 0;
                    }
                });
                
                // Obtener depósitos aprobados
                const depositosSnapshot = await db.collection('depositos_dinero_negro')
                    .where('estado', '==', 'aprobado')
                    .get();
                
                depositosSnapshot.forEach(doc => {
                    const deposito = doc.data();
                    const fechaAprobacion = deposito.fechaAprobacion?.toDate();
                    if (fechaAprobacion) {
                        const semana = getSemanaActual(fechaAprobacion);
                        if (!semanasMap[semana]) {
                            semanasMap[semana] = 0;
                        }
                        semanasMap[semana] += deposito.montoTotal || 0;
                    }
                });
                
                return Object.keys(semanasMap).sort().map(semana => ({
                    semana,
                    dinero: semanasMap[semana]
                }));
            } catch (error) {
                console.error('Error obteniendo dinero por semanas:', error);
                return [];
            }
        }

        async function obtenerEntregasPorDias() {
            try {
                const snapshot = await db.collection('entregas_productos')
                    .where('estado', '==', 'confirmado')
                    .get();
                
                const diasMap = {};
                const hoy = new Date();
                
                // Inicializar últimos 30 días
                for (let i = 29; i >= 0; i--) {
                    const fecha = new Date(hoy);
                    fecha.setDate(fecha.getDate() - i);
                    const fechaStr = fecha.toISOString().split('T')[0];
                    diasMap[fechaStr] = 0;
                }
                
                snapshot.forEach(doc => {
                    const entrega = doc.data();
                    const fechaConfirmacion = entrega.fechaConfirmacion?.toDate();
                    if (fechaConfirmacion) {
                        const fechaStr = fechaConfirmacion.toISOString().split('T')[0];
                        if (diasMap.hasOwnProperty(fechaStr)) {
                            diasMap[fechaStr] += 1;
                        }
                    }
                });
                
                return Object.keys(diasMap).map(fecha => ({
                    fecha: new Date(fecha).toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit' }),
                    cantidad: diasMap[fecha]
                }));
            } catch (error) {
                console.error('Error obteniendo entregas por días:', error);
                return [];
            }
        }

        function mostrarGraficaDias(datos) {
            const ctx = document.getElementById('dineroDiasChart').getContext('2d');
            
            if (dineroDiasChart) {
                dineroDiasChart.destroy();
            }

            dineroDiasChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: datos.map(d => d.fecha),
                    datasets: [{
                        label: 'Dinero Entregado ($)',
                        data: datos.map(d => d.dinero),
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Dinero ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function mostrarGraficaSemanas(datos) {
            const ctx = document.getElementById('dineroSemanasChart').getContext('2d');
            
            if (dineroSemanasChart) {
                dineroSemanasChart.destroy();
            }

            dineroSemanasChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datos.map(d => `Semana ${d.semana.split('-')[1]}`),
                    datasets: [{
                        label: 'Dinero Entregado ($)',
                        data: datos.map(d => d.dinero),
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Dinero ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function mostrarGraficaEntregasDias(datos) {
            const ctx = document.getElementById('entregasDiasChart').getContext('2d');
            
            if (entregasDiasChart) {
                entregasDiasChart.destroy();
            }

            entregasDiasChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: datos.map(d => d.fecha),
                    datasets: [{
                        label: 'Entregas Confirmadas',
                        data: datos.map(d => d.cantidad),
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Entregas'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function mostrarTopVendedores(datos) {
            const container = document.getElementById('topVendedoresTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Vendedor</th>
                            <th>Total Entregado</th>
                            <th>Tickets</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                const rankClass = index === 0 ? 'oro' : index === 1 ? 'plata' : index === 2 ? 'bronce' : '';
                html += `
                    <tr>
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>${item.vendedorNombre}</td>
                        <td><strong>$${item.total.toLocaleString()}</strong></td>
                        <td>${item.tickets}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function mostrarTopDealers(datos) {
            const container = document.getElementById('topDealersTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Dealer</th>
                            <th>Entregas</th>
                            <th>Productos</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                const rankClass = index === 0 ? 'oro' : index === 1 ? 'plata' : index === 2 ? 'bronce' : '';
                html += `
                    <tr>
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>${item.dealerNombre}</td>
                        <td><strong>${item.entregas}</strong></td>
                        <td>${item.productosTotal}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Nueva función: Top Vendedor (Productos)
        async function obtenerTopVendedorProductos() {
            try {
                const snapshot = await db.collection('entregas_productos')
                    .where('estado', '==', 'confirmado')
                    .get();
                
                const vendedoresMap = {};
                
                snapshot.forEach(doc => {
                    const entrega = doc.data();
                    const vendedorId = entrega.vendedorId;
                    const vendedorNombre = entrega.vendedorNombre;
                    
                    if (!vendedoresMap[vendedorId]) {
                        vendedoresMap[vendedorId] = {
                            vendedorId,
                            vendedorNombre,
                            cantidadProductos: 0,
                            entregas: 0
                        };
                    }
                    
                    entrega.productos.forEach(producto => {
                        vendedoresMap[vendedorId].cantidadProductos += producto.cantidad || 0;
                    });
                    vendedoresMap[vendedorId].entregas += 1;
                });
                
                const vendedores = Object.values(vendedoresMap);
                vendedores.sort((a, b) => b.cantidadProductos - a.cantidadProductos);
                
                return vendedores.slice(0, 10);
            } catch (error) {
                console.error('Error obteniendo top vendedor productos:', error);
                return [];
            }
        }

        function mostrarTopVendedorProductos(datos) {
            const container = document.getElementById('topVendedorProductosTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Vendedor</th>
                            <th>Productos</th>
                            <th>Entregas</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                const rankClass = index === 0 ? 'oro' : index === 1 ? 'plata' : index === 2 ? 'bronce' : '';
                html += `
                    <tr>
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>${item.vendedorNombre}</td>
                        <td><strong>${item.cantidadProductos}</strong></td>
                        <td>${item.entregas}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Nueva función: Top Entrega de Dinero Negro (Tickets + Depósitos)
        async function obtenerTopEntregaDineroNegro() {
            try {
                const vendedoresMap = {};
                
                // Obtener tickets confirmados
                const ticketsSnapshot = await db.collection('tickets_dinero')
                    .where('estado', '==', 'confirmado')
                    .get();
                
                ticketsSnapshot.forEach(doc => {
                    const ticket = doc.data();
                    const vendedorId = ticket.vendedorId;
                    const vendedorNombre = ticket.vendedorNombre;
                    const monto = ticket.montoEntregado || 0;
                    
                    if (!vendedoresMap[vendedorId]) {
                        vendedoresMap[vendedorId] = {
                            vendedorId,
                            vendedorNombre,
                            total: 0,
                            tickets: 0,
                            depositos: 0
                        };
                    }
                    vendedoresMap[vendedorId].total += monto;
                    vendedoresMap[vendedorId].tickets += 1;
                });
                
                // Obtener depósitos aprobados
                const depositosSnapshot = await db.collection('depositos_dinero_negro')
                    .where('estado', '==', 'aprobado')
                    .get();
                
                depositosSnapshot.forEach(doc => {
                    const deposito = doc.data();
                    const usuarioId = deposito.usuarioId;
                    const usuarioNombre = deposito.usuarioNombre;
                    const monto = deposito.montoTotal || 0;
                    
                    if (!vendedoresMap[usuarioId]) {
                        vendedoresMap[usuarioId] = {
                            vendedorId: usuarioId,
                            vendedorNombre: usuarioNombre,
                            total: 0,
                            tickets: 0,
                            depositos: 0
                        };
                    }
                    vendedoresMap[usuarioId].total += monto;
                    vendedoresMap[usuarioId].depositos += 1;
                });
                
                const vendedores = Object.values(vendedoresMap);
                vendedores.sort((a, b) => b.total - a.total);
                
                return vendedores.slice(0, 10);
            } catch (error) {
                console.error('Error obteniendo top entrega dinero negro:', error);
                return [];
            }
        }

        function mostrarTopEntregaDineroNegro(datos) {
            const container = document.getElementById('topEntregaDineroNegroTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Usuario</th>
                            <th>Total</th>
                            <th>Tickets</th>
                            <th>Depósitos</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                const rankClass = index === 0 ? 'oro' : index === 1 ? 'plata' : index === 2 ? 'bronce' : '';
                html += `
                    <tr>
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>${item.vendedorNombre}</td>
                        <td><strong>$${item.total.toLocaleString()}</strong></td>
                        <td>${item.tickets}</td>
                        <td>${item.depositos}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Nueva función: Top Solo Dinero Negro (Solo Depósitos)
        async function obtenerTopSoloDineroNegro() {
            try {
                const snapshot = await db.collection('depositos_dinero_negro')
                    .where('estado', '==', 'aprobado')
                    .get();
                
                const usuariosMap = {};
                
                snapshot.forEach(doc => {
                    const deposito = doc.data();
                    const usuarioId = deposito.usuarioId;
                    const usuarioNombre = deposito.usuarioNombre;
                    const monto = deposito.montoTotal || 0;
                    
                    if (!usuariosMap[usuarioId]) {
                        usuariosMap[usuarioId] = {
                            usuarioId,
                            usuarioNombre,
                            total: 0,
                            depositos: 0
                        };
                    }
                    usuariosMap[usuarioId].total += monto;
                    usuariosMap[usuarioId].depositos += 1;
                });
                
                const usuarios = Object.values(usuariosMap);
                usuarios.sort((a, b) => b.total - a.total);
                
                return usuarios.slice(0, 10);
            } catch (error) {
                console.error('Error obteniendo top solo dinero negro:', error);
                return [];
            }
        }

        function mostrarTopSoloDineroNegro(datos) {
            const container = document.getElementById('topSoloDineroNegroTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Usuario</th>
                            <th>Total</th>
                            <th>Depósitos</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                const rankClass = index === 0 ? 'oro' : index === 1 ? 'plata' : index === 2 ? 'bronce' : '';
                html += `
                    <tr>
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>${item.usuarioNombre}</td>
                        <td><strong>$${item.total.toLocaleString()}</strong></td>
                        <td>${item.depositos}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function mostrarProductosMas(datos) {
            const container = document.getElementById('productosMasTable');
            
            if (datos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay datos</p>';
                return;
            }

            let html = `
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Producto</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            datos.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.nombre}</td>
                        <td><strong>${item.cantidad}</strong></td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function mostrarEstadoEntregas(datos) {
            const container = document.getElementById('estadoEntregasTable');
            
            if (datos.total === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay entregas</p>';
                return;
            }

            const porcentajeConfirmadas = datos.total > 0 ? ((datos.confirmadas / datos.total) * 100).toFixed(1) : 0;
            const porcentajePendientes = datos.total > 0 ? ((datos.pendientes / datos.total) * 100).toFixed(1) : 0;
            const porcentajeRechazadas = datos.total > 0 ? ((datos.rechazadas / datos.total) * 100).toFixed(1) : 0;

            let html = `
                <div style="padding: 1rem;">
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span><strong>Confirmadas:</strong></span>
                            <span>${datos.confirmadas} (${porcentajeConfirmadas}%)</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${porcentajeConfirmadas}%; height: 100%; background: #10b981;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span><strong>Pendientes:</strong></span>
                            <span>${datos.pendientes} (${porcentajePendientes}%)</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${porcentajePendientes}%; height: 100%; background: #f59e0b;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span><strong>Rechazadas:</strong></span>
                            <span>${datos.rechazadas} (${porcentajeRechazadas}%)</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${porcentajeRechazadas}%; height: 100%; background: #ef4444;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between;">
                            <span><strong>Total:</strong></span>
                            <span><strong>${datos.total}</strong></span>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Cargar estadísticas al iniciar
        cargarEstadisticas();
    </script>
</body>
</html>
